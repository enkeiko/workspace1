generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===== 기본 마스터 =====

// 파트너사 (멀티테넌시)
model Tenant {
  id                   String       @id @default(cuid())
  name                 String
  code                 String       @unique
  businessNo           String?      @unique
  representative       String?
  contactName          String?
  contactPhone         String?
  contactEmail         String?
  address              String?
  commissionType       CommissionType @default(RATE)
  defaultCommissionRate Float?      @default(0.1)
  bankName             String?
  bankAccount          String?
  bankHolder           String?
  status               TenantStatus @default(ACTIVE)
  contractStart        DateTime?
  contractEnd          DateTime?
  memo                 String?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  users                User[]
  stores               Store[]
  salesOrders          SalesOrder[]
  purchaseOrders       PurchaseOrder[]
  settlements          Settlement[]
  partnerPrices        PartnerPrice[]
  partnerSettlements   PartnerSettlement[]
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CommissionType {
  FIXED
  RATE
}

// 사용자
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          Role      @default(ADMIN)
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])
  status        UserStatus @default(ACTIVE)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 수주/발주
  salesOrdersCreated   SalesOrder[] @relation("SalesOrderCreator")
  salesOrdersConfirmed SalesOrder[] @relation("SalesOrderConfirmer")
  salesOrdersCancelled SalesOrder[] @relation("SalesOrderCanceller")
  purchaseOrdersCreated   PurchaseOrder[] @relation("PurchaseOrderCreator")
  purchaseOrdersConfirmed PurchaseOrder[] @relation("PurchaseOrderConfirmer")
  purchaseOrdersCancelled PurchaseOrder[] @relation("PurchaseOrderCanceller")
  purchaseOrdersCompleted PurchaseOrder[] @relation("PurchaseOrderCompleter")
  purchaseOrderExports PurchaseOrderExport[]

  // 정산/작업
  settlements          Settlement[]
  workLogs             WorkLog[]
  businessChecks       BusinessCheck[]

  // 알림
  notifications        Notification[]
  notificationSettings NotificationSetting[]

  // 세금계산서
  taxInvoicesIssued    TaxInvoice[] @relation("TaxInvoiceIssuer")
  taxInvoicesCreated   TaxInvoice[] @relation("TaxInvoiceCreator")

  // 견적서
  quotationsIssued     Quotation[] @relation("QuotationIssuer")
  quotationsCreated    Quotation[] @relation("QuotationCreator")

  // 거래명세서
  statementsIssued     Statement[] @relation("StatementIssuer")
  statementsCreated    Statement[] @relation("StatementCreator")

  // 작업 명세
  workStatementsConfirmed WorkStatement[] @relation("WorkStatementConfirmer")
  workStatementsCreated   WorkStatement[] @relation("WorkStatementCreator")

  // 입금 기록
  paymentRecords       PaymentRecord[]

  // Expert Review: Status History & Cost Adjustments
  statusHistories      StatusHistory[]
  costAdjustmentsApproved CostAdjustment[]

  // P1-1: Smart Extension
  campaignRenewalsAccepted CampaignRenewal[]
}

enum Role {
  SUPER_ADMIN
  PARTNER_ADMIN
  ADMIN
  OPERATOR
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// 고객 (계약자/광고주)
model Customer {
  id             String         @id @default(cuid())
  name           String
  businessNo     String?        @unique
  representative String?
  contactName    String?
  contactPhone   String?
  contactEmail   String?
  address        String?
  contractStart  DateTime?
  contractEnd    DateTime?
  monthlyBudget  Int?
  status         CustomerStatus @default(ACTIVE)
  memo           String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  stores         Store[]
  quotations     Quotation[]
  salesOrders    SalesOrder[]
  statements     Statement[]
}

enum CustomerStatus {
  ACTIVE
  PAUSED
  TERMINATED
}

// 매장
model Store {
  id             String      @id @default(cuid())
  tenantId       String?
  tenant         Tenant?     @relation(fields: [tenantId], references: [id])
  customerId     String?
  customer       Customer?   @relation(fields: [customerId], references: [id])
  name           String
  mid            String      @unique
  placeUrl       String?
  businessNo     String?
  representative String?
  contactName    String?
  contactPhone   String?
  contactEmail   String?
  address        String?
  category       String?
  status         StoreStatus @default(ACTIVE)
  memo           String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  salesOrderItems    SalesOrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  keywords           StoreKeyword[]
  settlements        Settlement[]
  workLogs           WorkLog[]
  paymentRecords     PaymentRecord[]
}

enum StoreStatus {
  ACTIVE
  PAUSED
  TERMINATED
}

// 상품 (서비스)
model Product {
  id            String        @id @default(cuid())
  code          String        @unique
  name          String
  type          ProductType
  description   String?

  // 판매 단가 (고객에게)
  saleUnitPrice Int           @default(0)

  // 매입 단가 (채널에)
  costUnitPrice Int           @default(0)

  channelId     String?
  channel       Channel?      @relation(fields: [channelId], references: [id])

  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  quotationItems     QuotationItem[]
  salesOrderItems    SalesOrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  statementItems     StatementItem[]
  billingRules       BillingRule[]
}

enum ProductType {
  TRAFFIC     // 트래픽
  SAVE        // 저장
  REVIEW      // 리뷰
  DIRECTION   // 길찾기
  BLOG        // 블로그
  RECEIPT     // 영수증
}

// 채널 (공급업체)
model Channel {
  id               String        @id @default(cuid())
  name             String
  code             String        @unique
  type             ChannelType
  baseUnitPrice    Int
  minQty           Int?
  minDays          Int?
  maxDays          Int?
  sameDayDeadline  String?
  nextDayDeadline  String?
  weekendAvailable Boolean       @default(false)
  status           ChannelStatus @default(ACTIVE)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  products         Product[]
  sheets           ChannelSheet[]
  purchaseOrders   PurchaseOrder[]
  settlements      Settlement[]
  partnerPrices    PartnerPrice[]
}

enum ChannelType {
  REVIEW
  SAVE
  DIRECTION
  TRAFFIC
}

enum ChannelStatus {
  ACTIVE
  INACTIVE
}

// 채널별 시트 설정
model ChannelSheet {
  id             String    @id @default(cuid())
  channelId      String
  channel        Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sheetType      SheetType
  sheetName      String
  spreadsheetId  String
  spreadsheetUrl String
  sheetTabName   String?
  columnMapping  Json?
  headerRow      Int       @default(1)
  dataStartRow   Int       @default(2)
  syncSchedule   String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  purchaseOrderExports PurchaseOrderExport[]
  sheetImportLogs      SheetImportLog[]
}

enum SheetType {
  ORDER
  RECEIPT
  WORK_REPORT
  SETTLEMENT
  KEYWORD_RANK
}

// ===== 견적서 Quotation =====

model Quotation {
  id              String          @id @default(cuid())
  quotationNo     String          @unique  // QT260113-0001

  // 고객 정보
  customerId      String?
  customer        Customer?       @relation(fields: [customerId], references: [id])

  // 견적 기본 정보
  issueDate       DateTime        @default(now())
  validUntil      DateTime?

  // 공급자 정보 (당사)
  supplierName    String
  supplierBusinessNo String?
  supplierCeoName String?
  supplierAddr    String?
  supplierPhone   String?
  supplierEmail   String?

  // 공급받는자 정보 (고객)
  receiverName    String
  receiverBusinessNo String?
  receiverCeoName String?
  receiverAddr    String?
  receiverPhone   String?
  receiverEmail   String?

  // 금액
  supplyAmount    Int             // 공급가액
  taxAmount       Int             // 세액
  totalAmount     Int             // 합계

  note            String?
  status          QuotationStatus @default(DRAFT)

  // 전환된 수주
  convertedToSalesOrderId String? @unique
  convertedToSalesOrder   SalesOrder? @relation("QuotationToSalesOrder")
  convertedAt     DateTime?

  // 관리
  issuedById      String?
  issuedBy        User?           @relation("QuotationIssuer", fields: [issuedById], references: [id])
  createdById     String
  createdBy       User            @relation("QuotationCreator", fields: [createdById], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  items           QuotationItem[]

  @@index([customerId])
  @@index([issueDate])
  @@index([status])
}

model QuotationItem {
  id            String     @id @default(cuid())
  quotationId   String
  quotation     Quotation  @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  seq           Int        @default(1)

  productId     String?
  product       Product?   @relation(fields: [productId], references: [id])

  itemName      String
  itemSpec      String?
  quantity      Int        @default(1)
  unitPrice     Int        @default(0)
  supplyAmount  Int        @default(0)
  taxAmount     Int        @default(0)
  note          String?
  createdAt     DateTime   @default(now())

  @@index([quotationId])
}

enum QuotationStatus {
  DRAFT       // 초안
  ISSUED      // 발행됨
  SENT        // 전송됨
  ACCEPTED    // 수락됨 (수주 전환)
  REJECTED    // 거절됨
  EXPIRED     // 만료됨
}

// ===== 수주 Sales Order =====

model SalesOrder {
  id              String           @id @default(cuid())
  salesOrderNo    String           @unique  // SO260113-0001

  tenantId        String?
  tenant          Tenant?          @relation(fields: [tenantId], references: [id])

  customerId      String?
  customer        Customer?        @relation(fields: [customerId], references: [id])

  // 원본 견적서 (있는 경우)
  sourceQuotationId String?        @unique
  sourceQuotation Quotation?       @relation("QuotationToSalesOrder", fields: [sourceQuotationId], references: [id])

  orderDate       DateTime         @default(now())

  // 금액
  supplyAmount    Int              @default(0)
  taxAmount       Int              @default(0)
  totalAmount     Int              @default(0)

  status          SalesOrderStatus @default(DRAFT)
  memo            String?

  // 확정 정보
  confirmedAt     DateTime?
  confirmedById   String?
  confirmedBy     User?            @relation("SalesOrderConfirmer", fields: [confirmedById], references: [id])

  // 취소 정보
  cancelledAt     DateTime?
  cancelledById   String?
  cancelledBy     User?            @relation("SalesOrderCanceller", fields: [cancelledById], references: [id])
  cancelReason    String?

  // 관리
  createdById     String
  createdBy       User             @relation("SalesOrderCreator", fields: [createdById], references: [id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  items           SalesOrderItem[]
  purchaseOrders  PurchaseOrder[]
  statements      Statement[]
  clientReports   ClientReport[]     // P2-1: Client Secret Viewer

  @@index([customerId])
  @@index([orderDate])
  @@index([status])
}

model SalesOrderItem {
  id              String              @id @default(cuid())
  salesOrderId    String
  salesOrder      SalesOrder          @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  seq             Int                 @default(1)

  storeId         String?
  store           Store?              @relation(fields: [storeId], references: [id])

  productId       String?
  product         Product?            @relation(fields: [productId], references: [id])

  productType     ProductType
  keyword         String?

  dailyQty        Int                 @default(0)
  startDate       DateTime?
  endDate         DateTime?
  workDays        Int                 @default(0)
  totalQty        Int                 @default(0)

  unitPrice       Int                 @default(0)
  supplyAmount    Int                 @default(0)
  taxAmount       Int                 @default(0)

  note            String?
  status          SalesOrderItemStatus @default(PENDING)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([salesOrderId])
  @@index([storeId])
}

enum SalesOrderStatus {
  DRAFT        // 초안
  CONFIRMED    // 확정
  IN_PROGRESS  // 진행중
  COMPLETED    // 완료
  CANCELLED    // 취소
}

enum SalesOrderItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ===== 발주 Purchase Order =====

model PurchaseOrder {
  id              String              @id @default(cuid())
  purchaseOrderNo String              @unique  // PO260113-0001

  tenantId        String?
  tenant          Tenant?             @relation(fields: [tenantId], references: [id])

  // 원본 수주 (있는 경우)
  salesOrderId    String?
  salesOrder      SalesOrder?         @relation(fields: [salesOrderId], references: [id])

  channelId       String
  channel         Channel             @relation(fields: [channelId], references: [id])

  orderWeek       String
  orderDate       DateTime

  totalQty        Int                 @default(0)
  totalAmount     Int                 @default(0)

  status          PurchaseOrderStatus @default(DRAFT)
  memo            String?
  note            String?

  // 확정 정보
  confirmedAt     DateTime?
  confirmedById   String?
  confirmedBy     User?               @relation("PurchaseOrderConfirmer", fields: [confirmedById], references: [id])

  // 취소 정보
  cancelledAt     DateTime?
  cancelledById   String?
  cancelledBy     User?               @relation("PurchaseOrderCanceller", fields: [cancelledById], references: [id])
  cancelReason    String?

  // 완료 정보
  completedAt     DateTime?
  completedById   String?
  completedBy     User?               @relation("PurchaseOrderCompleter", fields: [completedById], references: [id])

  // Expert Review: Manual Override
  isManualOverride Boolean            @default(false)
  manualOverrideReason String?

  // 관리
  createdById     String
  createdBy       User                @relation("PurchaseOrderCreator", fields: [createdById], references: [id])
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Optimistic Concurrency Control
  version         Int                 @default(1)

  items           PurchaseOrderItem[]
  exports         PurchaseOrderExport[]
  workLogs        WorkLog[]
  workStatements  WorkStatement[]
  sheetImportLogs SheetImportLog[]
  costAdjustments CostAdjustment[]

  // P1-1: Smart Extension
  originalRenewals CampaignRenewal[] @relation("OriginalOrder")
  renewedFrom      CampaignRenewal?  @relation("RenewedOrder")

  @@index([salesOrderId])
  @@index([channelId])
  @@index([orderDate])
  @@index([status])
  @@index([version])
}

model PurchaseOrderItem {
  id              String                  @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder           @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  storeId         String
  store           Store                   @relation(fields: [storeId], references: [id])

  productId       String?
  product         Product?                @relation(fields: [productId], references: [id])

  productType     ProductType
  keyword         String

  dailyQty        Int
  startDate       DateTime
  endDate         DateTime
  workDays        Int
  totalQty        Int
  unitPrice       Int
  amount          Int

  note            String?
  status          PurchaseOrderItemStatus @default(PENDING)

  // Expert Review: Evidence-Based Billing
  proofUrl        String?           // 작업 증빙 URL (스크린샷, 링크 등)
  proofNote       String?           // 증빙 메모
  thumbnailUrl    String?           // 증빙 썸네일 URL
  completedAt     DateTime?         // 작업 완료일

  // Performance-based Billing (성과 기반 정산)
  goalType        GoalType          @default(RANKING)
  targetRank      Int?              @default(5)      // 목표 순위
  guaranteeDays   Int?              @default(25)     // 보장 일수
  successDays     Int               @default(0)      // 성공 일수
  failDays        Int               @default(0)      // 실패 일수
  currentRank     Int?                               // 현재 순위
  refundPerDay    Int?                               // 일별 환불액

  // Expert Review: Manual Override
  isManualOverride Boolean          @default(false)
  manualOverrideReason String?

  // Optimistic Concurrency Control
  version         Int                     @default(1)

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  workStatementItems WorkStatementItem[]

  @@index([purchaseOrderId])
  @@index([storeId])
  @@index([version])
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PurchaseOrderItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Performance-based Billing Enums
enum GoalType {
  RANKING      // 순위 보장형
  TRAFFIC      // 트래픽 보장형
  FULL_PERIOD  // 전 기간 보장형
}

enum BillingRuleType {
  RANK_GUARANTEE     // 순위 보장
  COMPLETION_BASED   // 완료 기반
  HYBRID             // 혼합형
}

enum RefundType {
  DAILY_PRORATED  // 일별 비례 환불
  FULL_REFUND     // 전액 환불
  NO_REFUND       // 환불 없음
}

// 상품별 정산 규칙
model BillingRule {
  id                String          @id @default(cuid())
  productId         String
  product           Product         @relation(fields: [productId], references: [id])
  ruleType          BillingRuleType
  targetRank        Int?            // 목표 순위 (RANK_GUARANTEE)
  minCompletionRate Float?          // 최소 완료율 (COMPLETION_BASED)
  refundType        RefundType      @default(DAILY_PRORATED)
  refundRate        Float           @default(1.0)  // 환불률 (0.0 ~ 1.0)
  effectiveFrom     DateTime        @default(now())
  effectiveTo       DateTime?
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([productId])
  @@index([isActive])
}

// 발주서 출력 이력
model PurchaseOrderExport {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  channelSheetId   String
  channelSheet     ChannelSheet  @relation(fields: [channelSheetId], references: [id])
  spreadsheetUrl   String
  sheetTabName     String?
  rowRange         String?
  status           ExportStatus  @default(SUCCESS)
  errorMessage     String?
  exportedById     String
  exportedBy       User          @relation(fields: [exportedById], references: [id])
  exportedAt       DateTime      @default(now())

  @@index([purchaseOrderId])
}

enum ExportStatus {
  SUCCESS
  FAILED
}

// ===== 거래명세서 Statement =====

model Statement {
  id              String          @id @default(cuid())
  statementNo     String          @unique  // ST260113-0001

  // 수주 연결
  salesOrderId    String?
  salesOrder      SalesOrder?     @relation(fields: [salesOrderId], references: [id])

  customerId      String?
  customer        Customer?       @relation(fields: [customerId], references: [id])

  // 명세서 정보
  issueDate       DateTime        @default(now())

  // 공급자 정보 (당사)
  supplierName    String
  supplierBusinessNo String?
  supplierCeoName String?
  supplierAddr    String?
  supplierPhone   String?
  supplierEmail   String?

  // 공급받는자 정보 (고객)
  receiverName    String
  receiverBusinessNo String?
  receiverCeoName String?
  receiverAddr    String?
  receiverPhone   String?
  receiverEmail   String?

  // 금액
  supplyAmount    Int
  taxAmount       Int
  totalAmount     Int

  note            String?
  status          StatementStatus @default(DRAFT)

  // 관리
  issuedById      String?
  issuedBy        User?           @relation("StatementIssuer", fields: [issuedById], references: [id])
  createdById     String
  createdBy       User            @relation("StatementCreator", fields: [createdById], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  items           StatementItem[]

  @@index([salesOrderId])
  @@index([customerId])
  @@index([issueDate])
}

model StatementItem {
  id            String     @id @default(cuid())
  statementId   String
  statement     Statement  @relation(fields: [statementId], references: [id], onDelete: Cascade)
  seq           Int        @default(1)

  productId     String?
  product       Product?   @relation(fields: [productId], references: [id])

  itemDate      DateTime?
  itemName      String
  itemSpec      String?
  quantity      Int        @default(1)
  unitPrice     Int        @default(0)
  supplyAmount  Int        @default(0)
  taxAmount     Int        @default(0)
  note          String?
  createdAt     DateTime   @default(now())

  @@index([statementId])
}

enum StatementStatus {
  DRAFT       // 초안
  ISSUED      // 발행됨
  SENT        // 전송됨
}

// ===== 기타 모델들 =====

// 매장 키워드
model StoreKeyword {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  keyword   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  rankings  KeywordRanking[]
}

// 키워드 순위 기록
model KeywordRanking {
  id             String       @id @default(cuid())
  storeKeywordId String
  storeKeyword   StoreKeyword @relation(fields: [storeKeywordId], references: [id], onDelete: Cascade)
  ranking        Int?
  checkDate      DateTime
  checkTime      String?
  previousRank   Int?
  rankChange     Int?
  createdAt      DateTime     @default(now())

  @@index([storeKeywordId, checkDate])
}

// 정산
model Settlement {
  id              String           @id @default(cuid())
  tenantId        String?
  tenant          Tenant?          @relation(fields: [tenantId], references: [id])
  storeId         String
  store           Store            @relation(fields: [storeId], references: [id])
  channelId       String?
  channel         Channel?         @relation(fields: [channelId], references: [id])
  settlementMonth String
  type            SettlementType
  amount          Int
  description     String?
  status          SettlementStatus @default(PENDING)
  taxInvoiceId    String?
  taxInvoice      TaxInvoice?      @relation(fields: [taxInvoiceId], references: [id])
  confirmedAt     DateTime?
  confirmedById   String?
  confirmedBy     User?            @relation(fields: [confirmedById], references: [id])

  // Expert Review: Unbillable Cost 처리
  // "Completed Work" != "Billable Work" 상황 추적
  billableAmount    Int?             // 청구 가능 금액
  unbillableAmount  Int?             // 청구 불가 금액 (작업 완료, 고객 미지불)
  adjustmentAmount  Int?             // 조정 금액
  unbillableReason  String?          // 청구 불가 사유

  // P3-1: Retroactive Settlement (소급분 정산)
  isRetroactive   Boolean          @default(false)
  originalMonth   String?          // 원래 정산월 (소급분인 경우)
  adjustmentNote  String?          // 조정 사유

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  lines           SettlementLine[]
  payments        PaymentRecord[]

  @@index([settlementMonth])
  @@index([storeId, settlementMonth])
  @@index([tenantId, settlementMonth])
  @@index([isRetroactive])
  @@index([originalMonth])
}

enum SettlementType {
  REVENUE
  COST
}

enum SettlementStatus {
  PENDING
  CONFIRMED
  PAID
}

// 마케팅 작업 로그
model WorkLog {
  id              String         @id @default(cuid())
  storeId         String
  store           Store          @relation(fields: [storeId], references: [id])
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  workType        WorkType
  workDate        DateTime
  description     String
  qty             Int?
  result          String?
  proofUrl        String?        // Evidence-Based Billing: 증빙 URL
  metadata        Json?          // 추가 메타데이터
  createdById     String
  createdBy       User           @relation(fields: [createdById], references: [id])
  createdAt       DateTime       @default(now())

  @@index([storeId, workDate])
}

enum WorkType {
  SALES_ORDER_CREATED
  SALES_ORDER_CONFIRMED
  SALES_ORDER_CANCELLED
  PURCHASE_ORDER_CREATED
  PURCHASE_ORDER_CONFIRMED
  PURCHASE_ORDER_COMPLETED
  PURCHASE_ORDER_CANCELLED
  CHANNEL_REPORT
  SHEET_IMPORT
  MANUAL_WORK
  KEYWORD_CHECK
  REVIEW_CHECK
  OTHER
}

// 사업자 상태 조회
model BusinessCheck {
  id               String              @id @default(cuid())
  businessNo       String
  corpName         String?
  taxType          String?
  taxTypeLabel     String?
  closedState      String?
  closedStateLabel String?
  closedDate       DateTime?
  status           BusinessCheckStatus
  result           Json?
  checkedAt        DateTime            @default(now())
  checkedById      String
  checkedBy        User                @relation(fields: [checkedById], references: [id])

  @@index([businessNo])
}

enum BusinessCheckStatus {
  ACTIVE
  CLOSED
  SUSPENDED
  UNKNOWN
}

// ===== 멀티테넌시 =====

model PartnerPrice {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  channelId     String
  channel       Channel   @relation(fields: [channelId], references: [id])
  unitPrice     Int
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([tenantId, channelId, effectiveFrom])
  @@index([tenantId])
  @@index([channelId])
}

model PartnerSettlement {
  id               String                  @id @default(cuid())
  tenantId         String
  tenant           Tenant                  @relation(fields: [tenantId], references: [id])
  settlementMonth  String
  orderAmount      Int
  revenueAmount    Int
  commissionRate   Float
  commissionAmount Int
  settlementAmount Int
  status           PartnerSettlementStatus @default(PENDING)
  paidAt           DateTime?
  memo             String?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  @@unique([tenantId, settlementMonth])
  @@index([settlementMonth])
}

enum PartnerSettlementStatus {
  PENDING
  CONFIRMED
  PAID
}

// ===== 세금계산서 =====

model TaxInvoice {
  id                  String           @id @default(cuid())
  type                TaxInvoiceType
  taxType             String           @default("TAX")
  purposeType         String           @default("CHARGE")
  issueDate           DateTime

  supplierBusinessNo  String
  supplierName        String
  supplierCeoName     String?
  supplierAddr        String?
  supplierBizType     String?
  supplierBizClass    String?
  supplierEmail       String?

  receiverBusinessNo  String
  receiverName        String
  receiverCeoName     String?
  receiverAddr        String?
  receiverBizType     String?
  receiverBizClass    String?
  receiverEmail       String?

  supplyAmount        Int
  taxAmount           Int
  totalAmount         Int

  ntsConfirmNo        String?
  status              TaxInvoiceStatus @default(DRAFT)
  barobillId          String?
  errorMessage        String?
  remark              String?

  issuedAt            DateTime?
  issuedById          String?
  issuedBy            User?            @relation("TaxInvoiceIssuer", fields: [issuedById], references: [id])

  createdById         String?
  createdBy           User?            @relation("TaxInvoiceCreator", fields: [createdById], references: [id])
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  items               TaxInvoiceItem[]
  settlements         Settlement[]

  @@index([type, issueDate])
  @@index([supplierBusinessNo])
  @@index([receiverBusinessNo])
  @@index([ntsConfirmNo])
}

model TaxInvoiceItem {
  id            String     @id @default(cuid())
  taxInvoiceId  String
  taxInvoice    TaxInvoice @relation(fields: [taxInvoiceId], references: [id], onDelete: Cascade)
  seq           Int        @default(1)
  itemDate      DateTime?
  itemName      String
  itemSpec      String?
  quantity      Int        @default(1)
  unitPrice     Int        @default(0)
  supplyAmount  Int        @default(0)
  taxAmount     Int        @default(0)
  note          String?
  createdAt     DateTime   @default(now())

  @@index([taxInvoiceId])
}

enum TaxInvoiceType {
  SALES
  PURCHASE
}

enum TaxInvoiceStatus {
  DRAFT
  ISSUED
  SENT
  FAILED
}

// ===== 알림 =====

model Notification {
  id          String             @id @default(cuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String
  data        Json?
  channel     NotificationChannel
  status      NotificationStatus @default(UNREAD)
  sentAt      DateTime?
  readAt      DateTime?
  createdAt   DateTime           @default(now())

  @@index([userId, status])
  @@index([createdAt])
}

enum NotificationType {
  QUOTATION_SENT
  SALES_ORDER_CREATED
  SALES_ORDER_CONFIRMED
  PURCHASE_ORDER_DEADLINE
  PURCHASE_ORDER_STATUS
  PAYMENT_REQUEST
  PAYMENT_CONFIRMED
  TAX_INVOICE_ISSUED
  KEYWORD_RANK_CHANGE
  BUSINESS_STATUS
  SYSTEM
}

enum NotificationChannel {
  SYSTEM
  KAKAO
  EMAIL
  SLACK
}

enum NotificationStatus {
  UNREAD
  READ
  SENT
  FAILED
}

model NotificationSetting {
  id               String              @id @default(cuid())
  userId           String
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationType NotificationType
  channel          NotificationChannel
  enabled          Boolean             @default(true)
  receiver         String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@unique([userId, notificationType, channel])
}

// ===== 작업 명세 (Work Statement) =====

model WorkStatement {
  id                String              @id @default(cuid())
  statementNo       String              @unique  // WS260113-0001

  // 발주 연결
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder       @relation(fields: [purchaseOrderId], references: [id])

  // 기간
  periodStart       DateTime
  periodEnd         DateTime

  // 금액
  supplyAmount      Int                 @default(0)
  taxAmount         Int                 @default(0)
  totalAmount       Int                 @default(0)

  status            WorkStatementStatus @default(DRAFT)
  note              String?

  confirmedAt       DateTime?
  confirmedById     String?
  confirmedBy       User?               @relation("WorkStatementConfirmer", fields: [confirmedById], references: [id])

  createdById       String
  createdBy         User                @relation("WorkStatementCreator", fields: [createdById], references: [id])
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  items             WorkStatementItem[]
  settlementLines   SettlementLine[]
  costAdjustments   CostAdjustment[]

  @@index([purchaseOrderId])
  @@index([periodEnd])
  @@index([status])
}

model WorkStatementItem {
  id                    String         @id @default(cuid())
  workStatementId       String
  workStatement         WorkStatement  @relation(fields: [workStatementId], references: [id], onDelete: Cascade)
  seq                   Int            @default(1)

  purchaseOrderItemId   String
  purchaseOrderItem     PurchaseOrderItem @relation(fields: [purchaseOrderItemId], references: [id])

  completedQty          Int            @default(0)
  unitPriceSnapshot     Int            @default(0)  // 확정 시점 단가
  amount                Int            @default(0)  // completedQty * unitPriceSnapshot

  // Expert Review: Evidence-Based Billing
  proofUrl              String?        // 작업 증빙 URL
  proofNote             String?        // 증빙 메모

  note                  String?
  createdAt             DateTime       @default(now())

  @@index([workStatementId])
  @@index([purchaseOrderItemId])
}

enum WorkStatementStatus {
  DRAFT       // 초안
  CONFIRMED   // 확정 (정산 생성됨)
  LOCKED      // 잠금 (수정 불가)
}

// ===== 정산 라인 (Settlement Line) =====

model SettlementLine {
  id                String         @id @default(cuid())
  settlementId      String
  settlement        Settlement     @relation(fields: [settlementId], references: [id], onDelete: Cascade)

  workStatementId   String
  workStatement     WorkStatement  @relation(fields: [workStatementId], references: [id])

  supplyAmount      Int            @default(0)
  taxAmount         Int            @default(0)
  totalAmount       Int            @default(0)

  createdAt         DateTime       @default(now())

  @@index([settlementId])
  @@index([workStatementId])
}

// ===== 입금 기록 (Payment Record) =====

model PaymentRecord {
  id              String         @id @default(cuid())
  settlementId    String?
  settlement      Settlement?    @relation(fields: [settlementId], references: [id])
  storeId         String?
  store           Store?         @relation(fields: [storeId], references: [id])

  amount          Int
  paymentDate     DateTime
  paymentMethod   PaymentMethod  @default(TRANSFER)
  depositorName   String?
  matchedType     MatchedType    @default(MANUAL)
  memo            String?

  createdById     String
  createdBy       User           @relation(fields: [createdById], references: [id])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([settlementId])
  @@index([storeId])
  @@index([paymentDate])
}

enum PaymentMethod {
  TRANSFER
  CARD
  CASH
  OTHER
}

enum MatchedType {
  AUTO
  MANUAL
}

// ===== Expert Review 권장사항 반영 =====

// 1. Google Sheet Staging Table (The "Google Sheet Trap" 해결)
// Sheet -> Staging (Raw) -> Validation -> Core DB 패턴
model SheetImportLog {
  id              String            @id @default(cuid())
  channelSheetId  String
  channelSheet    ChannelSheet      @relation(fields: [channelSheetId], references: [id])

  // 원본 데이터
  rawData         Json              // 시트에서 읽어온 원본 데이터
  rowNumber       Int?              // 시트 행 번호

  // 검증 결과
  status          ImportStatus      @default(PENDING)
  validationErrors Json?            // 검증 실패 사유

  // 매칭 결과
  matchedPurchaseOrderId String?
  matchedPurchaseOrder   PurchaseOrder? @relation(fields: [matchedPurchaseOrderId], references: [id])

  // 처리 정보
  processedAt     DateTime?
  processedById   String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([channelSheetId])
  @@index([status])
  @@index([createdAt])
}

enum ImportStatus {
  PENDING       // 대기
  VALIDATED     // 검증 완료
  FAILED        // 검증 실패
  PROCESSED     // 처리 완료
  SKIPPED       // 건너뜀
}

// 2. Status History Log (Universal Search & 상태 추적)
model StatusHistory {
  id            String        @id @default(cuid())

  // 다형성 참조 (어떤 엔티티의 상태 변경인지)
  entityType    EntityType
  entityId      String

  // 상태 변경 내역
  fromStatus    String?
  toStatus      String
  reason        String?       // 변경 사유

  // Manual Override 여부
  isManualOverride Boolean    @default(false)

  // 변경자
  changedById   String?
  changedBy     User?         @relation(fields: [changedById], references: [id])
  changedAt     DateTime      @default(now())

  @@index([entityType, entityId])
  @@index([changedAt])
}

enum EntityType {
  QUOTATION
  SALES_ORDER
  PURCHASE_ORDER
  WORK_STATEMENT
  SETTLEMENT
  TAX_INVOICE
}

// 3. Unbillable Cost 처리를 위한 CostAdjustment
// "Completed Work" != "Billable Work" 상황 처리
model CostAdjustment {
  id              String              @id @default(cuid())

  // 연결된 발주/명세
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder?      @relation(fields: [purchaseOrderId], references: [id])
  workStatementId String?
  workStatement   WorkStatement?      @relation(fields: [workStatementId], references: [id])

  // 조정 내역
  adjustmentType  AdjustmentType
  amount          Int                 // 조정 금액
  reason          String              // 조정 사유

  // 승인 정보
  status          AdjustmentStatus    @default(PENDING)
  approvedById    String?
  approvedBy      User?               @relation(fields: [approvedById], references: [id])
  approvedAt      DateTime?

  createdById     String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([purchaseOrderId])
  @@index([workStatementId])
}

enum AdjustmentType {
  UNBILLABLE      // 청구 불가 (작업 완료, 고객 미지불)
  DISCOUNT        // 할인
  PENALTY         // 페널티
  CORRECTION      // 정정
  OTHER           // 기타
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
}

// ===== P1-1: Smart Extension (캠페인 자동 연장) =====

model CampaignRenewal {
  id                String          @id @default(cuid())
  originalOrderId   String
  originalOrder     PurchaseOrder   @relation("OriginalOrder", fields: [originalOrderId], references: [id])
  proposedStartDate DateTime
  proposedEndDate   DateTime
  proposedAmount    Int
  status            RenewalStatus   @default(PENDING)
  renewedOrderId    String?         @unique
  renewedOrder      PurchaseOrder?  @relation("RenewedOrder", fields: [renewedOrderId], references: [id])
  expiryNotifiedAt  DateTime?
  acceptedAt        DateTime?
  acceptedById      String?
  acceptedBy        User?           @relation(fields: [acceptedById], references: [id])
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([originalOrderId])
  @@index([status])
  @@index([proposedEndDate])
}

enum RenewalStatus {
  PENDING    // 대기
  ACCEPTED   // 수락됨
  DECLINED   // 거절됨
  EXPIRED    // 만료됨
}

// ===== P2-1: Client Secret Viewer (고객 공개 리포트) =====

model ClientReport {
  id              String      @id @default(cuid())
  secretToken     String      @unique @default(cuid())
  salesOrderId    String
  salesOrder      SalesOrder  @relation(fields: [salesOrderId], references: [id])
  title           String
  description     String?
  showPricing     Boolean     @default(false)
  expiresAt       DateTime?
  viewCount       Int         @default(0)
  lastViewedAt    DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([secretToken])
  @@index([salesOrderId])
}
