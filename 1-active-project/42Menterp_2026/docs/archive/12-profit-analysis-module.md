# 12. ì†ìµë¶„ì„ ëª¨ë“ˆ ìƒì„¸ ì„¤ê³„

> Profit Analysis Module - ë¹„ì¦ˆë‹ˆìŠ¤ í•µì‹¬ ê°€ì¹˜

## 1. ê°œìš”

### 1.1 ëª¨ë“ˆ ëª©ì 

ì†ìµë¶„ì„ì€ **"ì´ë²ˆ ë‹¬ ì–¼ë§ˆ ë²Œì—ˆëŠ”ê°€?"** ì— ë‹µí•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

```
ì´ìµ = ë§¤ì¶œ(ê³ ê° ì²­êµ¬) - ë¹„ìš©(ê±°ë˜ì²˜ ë°œì£¼)
```

### 1.2 í•µì‹¬ ê¸°ëŠ¥

| ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|
| ì£¼ë¬¸ë³„ ì†ìµ | ê° ì£¼ë¬¸ì˜ ë§¤ì¶œ/ë¹„ìš©/ì´ìµ ìë™ ê³„ì‚° |
| ê³ ê°ë³„ ì†ìµ | ê³ ê°ë³„ ìˆ˜ìµì„± ë¶„ì„ |
| ê¸°ê°„ë³„ ì†ìµ | ì¼/ì£¼/ì›”/ë¶„ê¸°/ì—° ì†ìµ ì¶”ì´ |
| ê±°ë˜ì²˜ë³„ ë¶„ì„ | ê±°ë˜ì²˜ë³„ ì§€ì¶œ í˜„í™© |
| ëŒ€ì‹œë³´ë“œ ì—°ë™ | ì‹¤ì‹œê°„ ì†ìµ ìš”ì•½ |

---

## 2. ë°ì´í„° ëª¨ë¸

### 2.1 ProfitAnalysis (ì†ìµë¶„ì„)

```prisma
model ProfitAnalysis {
  id            Int       @id @default(autoincrement())
  
  // ì—°ê²°
  orderId       Int       @unique          // ì£¼ë¬¸ (1:1)
  
  // ë§¤ì¶œ
  revenue       Decimal                    // ë§¤ì¶œì•¡ (Order.totalAmount)
  
  // ë¹„ìš©
  costOfGoods   Decimal                    // ë§¤ì…ì›ê°€ (Î£ PurchaseOrder.totalAmount)
  operatingCost Decimal   @default(0)      // ìš´ì˜ë¹„ìš© (ì¸ê±´ë¹„, ê¸°íƒ€ - ì„ íƒ)
  totalCost     Decimal                    // ì´ ë¹„ìš© = ë§¤ì…ì›ê°€ + ìš´ì˜ë¹„ìš©
  
  // ì´ìµ
  grossProfit   Decimal                    // ë§¤ì¶œì´ì´ìµ = ë§¤ì¶œ - ë§¤ì…ì›ê°€
  netProfit     Decimal                    // ìˆœì´ìµ = ë§¤ì¶œ - ì´ë¹„ìš©
  
  // ì´ìµë¥ 
  grossMargin   Decimal                    // ë§¤ì¶œì´ì´ìµë¥  % = grossProfit / revenue * 100
  netMargin     Decimal                    // ìˆœì´ìµë¥  % = netProfit / revenue * 100
  
  // ë¶„ì„ ì •ë³´
  analysisDate  DateTime  @default(now())  // ë¶„ì„ ì¼ì‹œ
  isManual      Boolean   @default(false)  // ìˆ˜ë™ ì¡°ì • ì—¬ë¶€
  notes         String?                    // ë¶„ì„ ë©”ëª¨
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // ê´€ê³„
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([analysisDate])
}
```

### 2.2 í•µì‹¬ ê³„ì‚° ê³µì‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ì†ìµ ê³„ì‚° ê³µì‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  revenue (ë§¤ì¶œ)        = Order.totalAmount                  â”‚
â”‚                                                             â”‚
â”‚  costOfGoods (ë§¤ì…ì›ê°€) = Î£ PurchaseOrder.totalAmount       â”‚
â”‚                          (status â‰  'cancelled')             â”‚
â”‚                                                             â”‚
â”‚  grossProfit (ë§¤ì¶œì´ì´ìµ) = revenue - costOfGoods           â”‚
â”‚                                                             â”‚
â”‚  grossMargin (ë§¤ì¶œì´ì´ìµë¥ ) = (grossProfit / revenue) Ã— 100 â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  operatingCost (ìš´ì˜ë¹„ìš©) = ìˆ˜ë™ ì…ë ¥ ë˜ëŠ” ë¹„ìœ¨ ì ìš©         â”‚
â”‚                                                             â”‚
â”‚  totalCost (ì´ë¹„ìš©)     = costOfGoods + operatingCost       â”‚
â”‚                                                             â”‚
â”‚  netProfit (ìˆœì´ìµ)     = revenue - totalCost               â”‚
â”‚                                                             â”‚
â”‚  netMargin (ìˆœì´ìµë¥ )   = (netProfit / revenue) Ã— 100       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. API ì„¤ê³„

### 3.1 ì£¼ë¬¸ë³„ ì†ìµ ì¡°íšŒ

#### GET /api/profit-analysis/orders/[orderId]
íŠ¹ì • ì£¼ë¬¸ì˜ ì†ìµ ë¶„ì„

**Response:**
```json
{
  "success": true,
  "data": {
    "orderId": 1,
    "orderNumber": "ORD-202601-0001",
    "orderDate": "2026-01-05",
    "customer": {
      "id": 1,
      "name": "ê¸¸ë™ì´ë„¤ ì¹˜í‚¨"
    },
    "analysis": {
      "revenue": 1000000,
      "costOfGoods": 600000,
      "operatingCost": 0,
      "totalCost": 600000,
      "grossProfit": 400000,
      "netProfit": 400000,
      "grossMargin": 40.0,
      "netMargin": 40.0
    },
    "purchaseOrders": [
      {
        "id": 1,
        "poNumber": "PO-202601-0001",
        "supplier": "ë¸”ë¡œê·¸Aì‚¬",
        "totalAmount": 300000,
        "status": "completed"
      },
      {
        "id": 2,
        "poNumber": "PO-202601-0002",
        "supplier": "ë¦¬ë·°Bì‚¬",
        "totalAmount": 300000,
        "status": "completed"
      }
    ],
    "lastUpdated": "2026-01-10T09:30:00Z"
  }
}
```

### 3.2 ê¸°ê°„ë³„ ì†ìµ ì§‘ê³„

#### GET /api/profit-analysis/summary
ê¸°ê°„ë³„ ì†ìµ ìš”ì•½

**Query Parameters:**
| íŒŒë¼ë¯¸í„° | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ |
|---------|------|------|------|
| startDate | string | ì‹œì‘ì¼ | 2026-01-01 |
| endDate | string | ì¢…ë£Œì¼ | 2026-01-31 |
| groupBy | string | ì§‘ê³„ ë‹¨ìœ„ | day, week, month |

**Response:**
```json
{
  "success": true,
  "data": {
    "period": {
      "start": "2026-01-01",
      "end": "2026-01-31"
    },
    "summary": {
      "totalRevenue": 10000000,
      "totalCost": 6000000,
      "totalProfit": 4000000,
      "avgMargin": 40.0,
      "orderCount": 25,
      "avgOrderValue": 400000
    },
    "timeline": [
      {
        "date": "2026-01-01",
        "revenue": 500000,
        "cost": 300000,
        "profit": 200000,
        "margin": 40.0
      },
      // ... ì¼ë³„ ë°ì´í„°
    ],
    "comparison": {
      "previousPeriod": {
        "revenue": 8000000,
        "profit": 3200000
      },
      "revenueGrowth": 25.0,
      "profitGrowth": 25.0
    }
  }
}
```

### 3.3 ê³ ê°ë³„ ì†ìµ ë¶„ì„

#### GET /api/profit-analysis/by-customer
ê³ ê°ë³„ ì†ìµ ë­í‚¹

**Query Parameters:**
| íŒŒë¼ë¯¸í„° | íƒ€ì… | ì„¤ëª… |
|---------|------|------|
| startDate | string | ì‹œì‘ì¼ |
| endDate | string | ì¢…ë£Œì¼ |
| sortBy | string | revenue, profit, margin |
| limit | number | ì¡°íšŒ ê°œìˆ˜ |

**Response:**
```json
{
  "success": true,
  "data": {
    "customers": [
      {
        "customer": { "id": 1, "name": "Aê³ ê°" },
        "orderCount": 5,
        "revenue": 2500000,
        "cost": 1500000,
        "profit": 1000000,
        "margin": 40.0
      },
      {
        "customer": { "id": 2, "name": "Bê³ ê°" },
        "orderCount": 3,
        "revenue": 1500000,
        "cost": 750000,
        "profit": 750000,
        "margin": 50.0
      }
    ],
    "total": {
      "customers": 10,
      "revenue": 10000000,
      "profit": 4000000
    }
  }
}
```

### 3.4 ê±°ë˜ì²˜ë³„ ì§€ì¶œ ë¶„ì„

#### GET /api/profit-analysis/by-supplier
ê±°ë˜ì²˜ë³„ ì§€ì¶œ í˜„í™©

**Response:**
```json
{
  "success": true,
  "data": {
    "suppliers": [
      {
        "supplier": { "id": 1, "name": "ë¸”ë¡œê·¸Aì‚¬" },
        "poCount": 15,
        "totalSpent": 3000000,
        "avgPoValue": 200000
      },
      {
        "supplier": { "id": 2, "name": "ë¦¬ë·°Bì‚¬" },
        "poCount": 10,
        "totalSpent": 2000000,
        "avgPoValue": 200000
      }
    ],
    "total": {
      "suppliers": 5,
      "totalSpent": 6000000
    }
  }
}
```

### 3.5 ì†ìµ ì¬ê³„ì‚° API

#### POST /api/profit-analysis/recalculate
íŠ¹ì • ì£¼ë¬¸ ë˜ëŠ” ê¸°ê°„ì˜ ì†ìµ ì¬ê³„ì‚°

**Request Body:**
```json
{
  "orderId": 1,  // ë˜ëŠ”
  "startDate": "2026-01-01",
  "endDate": "2026-01-31"
}
```

---

## 4. UI ì„¤ê³„

### 4.1 ì†ìµ ëŒ€ì‹œë³´ë“œ ìœ„ì ¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ì´ë²ˆ ë‹¬ ì†ìµ (2026ë…„ 1ì›”)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    ë§¤ì¶œ      â”‚ â”‚    ë¹„ìš©      â”‚ â”‚    ì´ìµ      â”‚            â”‚
â”‚  â”‚  â‚©10,000,000 â”‚ â”‚  â‚©6,000,000  â”‚ â”‚  â‚©4,000,000  â”‚            â”‚
â”‚  â”‚    â†‘ 25%    â”‚ â”‚    â†‘ 20%    â”‚ â”‚    â†‘ 33%    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  í‰ê·  ì´ìµë¥ : 40%                                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     ë§¤ì¶œ/ì´ìµ ì¶”ì´ (ì¼ë³„)                                â”‚   â”‚
â”‚  â”‚  â‚©                                                       â”‚   â”‚
â”‚  â”‚  1M â”¤    â•­â”€â•®        â•­â”€â”€â•®                                â”‚   â”‚
â”‚  â”‚     â”‚   â•­â•¯ â•°â•®   â•­â”€â”€â•¯  â”‚    â•­â”€â•®                         â”‚   â”‚
â”‚  â”‚ 500Kâ”¤â”€â”€â•¯    â•°â”€â”€â”€â•¯     â•°â”€â”€â”€â”€â•¯ â•°â”€â”€â”€                      â”‚   â”‚
â”‚  â”‚     â”‚                                                    â”‚   â”‚
â”‚  â”‚     â””â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€                    â”‚   â”‚
â”‚  â”‚        1   5  10  15  20  25  30                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ì†ìµ ë¶„ì„ í˜ì´ì§€ `/profit-analysis`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì†ìµ ë¶„ì„                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [ê¸°ê°„: 2026.01.01 ~ 2026.01.31] [ì¡°íšŒ]          [Excel ë‹¤ìš´ë¡œë“œ]â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  [ì „ì²´ ìš”ì•½]  [ê³ ê°ë³„]  [ê±°ë˜ì²˜ë³„]  [ìƒí’ˆë³„]                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                 â”‚
â”‚  ì „ì²´ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚        â”‚ ë§¤ì¶œ   â”‚ ë¹„ìš©   â”‚ ì´ìµ   â”‚ ì´ìµë¥  â”‚               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚  â”‚ ì´ë²ˆë‹¬ â”‚ â‚©10M  â”‚ â‚©6M   â”‚ â‚©4M   â”‚ 40%   â”‚               â”‚
â”‚  â”‚ ì „ì›”   â”‚ â‚©8M   â”‚ â‚©4.8M â”‚ â‚©3.2M â”‚ 40%   â”‚               â”‚
â”‚  â”‚ ì¦ê°   â”‚ +25%  â”‚ +25%  â”‚ +25%  â”‚ 0%p   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                 â”‚
â”‚  ì£¼ë¬¸ë³„ ì†ìµ ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ì£¼ë¬¸ë²ˆí˜¸     â”‚ ê³ ê°     â”‚ ë§¤ì¶œ   â”‚ ë¹„ìš©   â”‚ ì´ìµ   â”‚ì´ìµë¥ â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ORD-202601-01â”‚ Aê³ ê°    â”‚ â‚©1M   â”‚ â‚©600K â”‚ â‚©400K â”‚ 40% â”‚â”‚
â”‚  â”‚ORD-202601-02â”‚ Bê³ ê°    â”‚ â‚©500K â”‚ â‚©200K â”‚ â‚©300K â”‚ 60% â”‚â”‚
â”‚  â”‚ORD-202601-03â”‚ Cê³ ê°    â”‚ â‚©2M   â”‚ â‚©1.5M â”‚ â‚©500K â”‚ 25% â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ì£¼ë¬¸ ìƒì„¸ - ì†ìµ ì„¹ì…˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ì†ìµ ë¶„ì„                                      [ì¬ê³„ì‚°]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   ë§¤ì¶œ        â‚©1,000,000  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%    â”‚   â”‚
â”‚  â”‚   ë¹„ìš©        â‚©  600,000  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         60%     â”‚   â”‚
â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚  â”‚   ì´ìµ        â‚©  400,000  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ             40%     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ë¹„ìš© ë‚´ì—­:                                                     â”‚
â”‚  â€¢ ë¸”ë¡œê·¸Aì‚¬ (PO-0001): â‚©300,000                               â”‚
â”‚  â€¢ ë¦¬ë·°Bì‚¬ (PO-0002): â‚©300,000                                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### 5.1 ì†ìµ ìë™ ê³„ì‚°

```typescript
interface ProfitData {
  revenue: number;
  costOfGoods: number;
  operatingCost: number;
  totalCost: number;
  grossProfit: number;
  netProfit: number;
  grossMargin: number;
  netMargin: number;
}

async function calculateOrderProfit(orderId: number): Promise<ProfitData> {
  // 1. ì£¼ë¬¸ ê¸ˆì•¡ (ë§¤ì¶œ)
  const order = await prisma.order.findUnique({
    where: { id: orderId }
  });
  const revenue = Number(order.totalAmount);
  
  // 2. ë°œì£¼ ê¸ˆì•¡ í•©ê³„ (ë§¤ì…ì›ê°€)
  const poResult = await prisma.purchaseOrder.aggregate({
    where: { 
      orderId,
      status: { notIn: ['draft', 'cancelled'] }
    },
    _sum: { totalAmount: true }
  });
  const costOfGoods = Number(poResult._sum.totalAmount) || 0;
  
  // 3. ìš´ì˜ë¹„ìš© (ì„ íƒì  - ë¹„ìœ¨ ë˜ëŠ” ê³ ì •)
  const operatingCost = 0; // ë˜ëŠ” ì„¤ì •ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  // 4. ê³„ì‚°
  const totalCost = costOfGoods + operatingCost;
  const grossProfit = revenue - costOfGoods;
  const netProfit = revenue - totalCost;
  const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;
  const netMargin = revenue > 0 ? (netProfit / revenue) * 100 : 0;
  
  return {
    revenue,
    costOfGoods,
    operatingCost,
    totalCost,
    grossProfit,
    netProfit,
    grossMargin: Math.round(grossMargin * 100) / 100,
    netMargin: Math.round(netMargin * 100) / 100
  };
}
```

### 5.2 ì†ìµ ì €ì¥/ì—…ë°ì´íŠ¸

```typescript
async function upsertProfitAnalysis(orderId: number): Promise<ProfitAnalysis> {
  const profitData = await calculateOrderProfit(orderId);
  
  return prisma.profitAnalysis.upsert({
    where: { orderId },
    update: {
      ...profitData,
      analysisDate: new Date()
    },
    create: {
      orderId,
      ...profitData
    }
  });
}
```

### 5.3 ìë™ ì¬ê³„ì‚° íŠ¸ë¦¬ê±°

```typescript
// ë°œì£¼ ìƒíƒœ ë³€ê²½ ì‹œ
async function onPurchaseOrderStatusChange(po: PurchaseOrder) {
  if (po.orderId && ['completed', 'cancelled'].includes(po.status)) {
    await upsertProfitAnalysis(po.orderId);
  }
}

// ì£¼ë¬¸ ê¸ˆì•¡ ë³€ê²½ ì‹œ
async function onOrderAmountChange(orderId: number) {
  await upsertProfitAnalysis(orderId);
}

// ë°œì£¼ ê¸ˆì•¡ ë³€ê²½ ì‹œ
async function onPurchaseOrderAmountChange(po: PurchaseOrder) {
  if (po.orderId) {
    await upsertProfitAnalysis(po.orderId);
  }
}
```

### 5.4 ê¸°ê°„ë³„ ì§‘ê³„

```typescript
async function getPeriodSummary(startDate: Date, endDate: Date) {
  const orders = await prisma.order.findMany({
    where: {
      orderDate: { gte: startDate, lte: endDate },
      status: { not: 'cancelled' }
    },
    include: {
      profitAnalysis: true
    }
  });
  
  let totalRevenue = 0;
  let totalCost = 0;
  let totalProfit = 0;
  
  for (const order of orders) {
    if (order.profitAnalysis) {
      totalRevenue += Number(order.profitAnalysis.revenue);
      totalCost += Number(order.profitAnalysis.totalCost);
      totalProfit += Number(order.profitAnalysis.grossProfit);
    } else {
      // ë¶„ì„ì´ ì—†ìœ¼ë©´ ê³„ì‚°
      const profit = await calculateOrderProfit(order.id);
      totalRevenue += profit.revenue;
      totalCost += profit.totalCost;
      totalProfit += profit.grossProfit;
    }
  }
  
  const avgMargin = totalRevenue > 0 
    ? (totalProfit / totalRevenue) * 100 
    : 0;
  
  return {
    totalRevenue,
    totalCost,
    totalProfit,
    avgMargin: Math.round(avgMargin * 100) / 100,
    orderCount: orders.length,
    avgOrderValue: orders.length > 0 ? totalRevenue / orders.length : 0
  };
}
```

### 5.5 ê³ ê°ë³„ ìˆ˜ìµì„± ë¶„ì„

```typescript
async function getCustomerProfitability(startDate: Date, endDate: Date) {
  const results = await prisma.order.groupBy({
    by: ['customerId'],
    where: {
      orderDate: { gte: startDate, lte: endDate },
      status: { not: 'cancelled' }
    },
    _count: { id: true },
    _sum: { totalAmount: true }
  });
  
  const customerProfits = await Promise.all(
    results.map(async (r) => {
      const customer = await prisma.customer.findUnique({
        where: { id: r.customerId }
      });
      
      // í•´ë‹¹ ê³ ê°ì˜ ëª¨ë“  ì£¼ë¬¸ ì†ìµ ì§‘ê³„
      const profitSum = await prisma.profitAnalysis.aggregate({
        where: {
          order: {
            customerId: r.customerId,
            orderDate: { gte: startDate, lte: endDate },
            status: { not: 'cancelled' }
          }
        },
        _sum: {
          revenue: true,
          totalCost: true,
          grossProfit: true
        }
      });
      
      const revenue = Number(profitSum._sum.revenue) || 0;
      const cost = Number(profitSum._sum.totalCost) || 0;
      const profit = Number(profitSum._sum.grossProfit) || 0;
      
      return {
        customer: { id: customer.id, name: customer.name },
        orderCount: r._count.id,
        revenue,
        cost,
        profit,
        margin: revenue > 0 ? (profit / revenue) * 100 : 0
      };
    })
  );
  
  return customerProfits.sort((a, b) => b.profit - a.profit);
}
```

---

## 6. ì—°ë™ í¬ì¸íŠ¸

### 6.1 ì£¼ë¬¸(Order) ëª¨ë“ˆ

- ì£¼ë¬¸ ìƒì„¸ì— ì†ìµ ì„¹ì…˜ í‘œì‹œ
- ì£¼ë¬¸ ê¸ˆì•¡ ë³€ê²½ ì‹œ ì¬ê³„ì‚° íŠ¸ë¦¬ê±°

### 6.2 êµ¬ë§¤ë°œì£¼(PurchaseOrder) ëª¨ë“ˆ

- ë°œì£¼ ì™„ë£Œ ì‹œ ì†ìµ ì¬ê³„ì‚°
- ë°œì£¼ ê¸ˆì•¡ ë³€ê²½ ì‹œ ì†ìµ ì¬ê³„ì‚°

### 6.3 ëŒ€ì‹œë³´ë“œ

- ê¸°ê°„ë³„ ì†ìµ ìœ„ì ¯
- ì›”ë³„ ì¶”ì´ ì°¨íŠ¸
- ì´ìµë¥  ê²½ê³  (ëª©í‘œ ëŒ€ë¹„)

### 6.4 ë³´ê³ ì„œ

- ì›”ê°„ ì†ìµ ë³´ê³ ì„œ (PDF/Excel)
- ê³ ê°ë³„ ìˆ˜ìµì„± ë³´ê³ ì„œ
- ê±°ë˜ì²˜ë³„ ì§€ì¶œ ë³´ê³ ì„œ

---

## 7. êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 1 (í•„ìˆ˜)
1. [ ] ProfitAnalysis ëª¨ë¸ ì¶”ê°€
2. [ ] ì†ìµ ê³„ì‚° ë¡œì§ êµ¬í˜„
3. [ ] ì£¼ë¬¸ë³„ ì†ìµ API
4. [ ] ê¸°ê°„ë³„ ì†ìµ ì§‘ê³„ API
5. [ ] ì£¼ë¬¸ ìƒì„¸ ì†ìµ ì„¹ì…˜

### Phase 2 (ê¶Œì¥)
6. [ ] ëŒ€ì‹œë³´ë“œ ì†ìµ ìœ„ì ¯
7. [ ] ê³ ê°ë³„ ë¶„ì„ API
8. [ ] ê±°ë˜ì²˜ë³„ ë¶„ì„ API
9. [ ] ì†ìµ ì¶”ì´ ì°¨íŠ¸

### Phase 3 (ì„ íƒ)
10. [ ] Excel ë‹¤ìš´ë¡œë“œ
11. [ ] PDF ë³´ê³ ì„œ
12. [ ] ì´ìµë¥  ì•Œë¦¼ (ëª©í‘œ ë¯¸ë‹¬ ì‹œ)

---

## ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ì—­ | ì‘ì„±ì |
|------|------|----------|--------|
| 1.0 | 2026-01-05 | ì´ˆì•ˆ ì‘ì„± | AI Assistant |


