# ì„¸ê¸ˆê³„ì‚°ì„œ ìë™í™” ë° ë°ì´í„° ì •ê·œí™” ì„¤ê³„ì„œ (Tax Invoice Automation Spec)

**ì‘ì„±ì¼:** 2026-01-14
**ë²„ì „:** 1.1
**ì‘ì„±ì:** Antigravity Agent (ERP Planning Director)
**ë³´ì™„ì:** Claude Opus 4.5 (ë°ì´í„° ë¶„ì„ ê¸°ë°˜)

---

## ğŸ”´ í•„ìˆ˜ ì°¸ì¡° ë¬¸ì„œ

| ë¬¸ì„œ | ë‚´ìš© | í•„ìˆ˜ |
|------|------|------|
| `DATA_ANALYSIS_INTEGRATION.md` | ìš´ì˜ ë°ì´í„° ë¶„ì„ ê²°ê³¼ ë° í†µí•© ì œì•ˆ | âœ… |
| `CUSTOMERS_ENHANCEMENT.md` | ê³ ê°ê´€ë¦¬ ê³ ë„í™” (ì„¸ê¸ˆê³„ì‚°ì„œ í•„ë“œ ê²€ì¦) | âœ… |
| `DATA_PATTERNS.md` | ì—‘ì…€ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ ê³µí†µ íŒ¨í„´ | âœ… |

---

## 1. ê°œìš” (Overview)

### 1.1 ë°°ê²½ ë° ëª©ì 
í˜„ì¬ "ë§¤ì¥(Store)"ê³¼ "ê³ ê°(Customer)" ë°ì´í„°ê°€ í˜¼ì¬ë˜ì–´ ê´€ë¦¬ë˜ê³  ìˆì–´, ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ì‹œ **'ëˆ„êµ¬ì—ê²Œ ë°œí–‰í•´ì•¼ í•˜ëŠ”ê°€?'**ë¥¼ íŒë‹¨í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. êµ­ì„¸ì²­(í™ˆíƒìŠ¤) ì¼ê´„ ë°œê¸‰ ì–‘ì‹ì— ë§ì¶”ê¸° ìœ„í•´ì„œëŠ” **ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ê¸°ì¤€**ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì •ê·œí™”í•˜ê³ , ì‹œìŠ¤í…œì—ì„œ ìë™ìœ¼ë¡œ ì—‘ì…€ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” íŒŒì´í”„ë¼ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.

### 1.2 ëª©í‘œ
1. **ë°ì´í„° ì •ê·œí™”:** í˜¼ì¬ëœ ì—‘ì…€ ëª©ë¡ì—ì„œ ìœ íš¨í•œ "ì²­êµ¬/ê³¼ê¸ˆ ì£¼ì²´(Bill-To Party)"ë¥¼ ì¶”ì¶œí•˜ì—¬ DBí™”.
2. **ìë™ ìƒì„±:** ì •ì‚° ë§ˆê° í›„, í´ë¦­ í•œ ë²ˆìœ¼ë¡œ í™ˆíƒìŠ¤ ì—…ë¡œë“œìš© ì—‘ì…€ íŒŒì¼ ìƒì„±.

---

## 2. ë°ì´í„° ë¶„ì„ ë° ë§¤í•‘ ì „ëµ

### 2.1 ì›ì²œ ë°ì´í„° ë¶„ì„ (ê±°ë˜ì²˜ëª©ë¡.xls)

> **ì‹¤ì œ ë¶„ì„ ê²°ê³¼**: `ê±°ë˜ì²˜ëª©ë¡(1~94).xls` íŒŒì¼ ê¸°ì¤€

**íŒŒì¼ êµ¬ì¡°:**
- ì‹œíŠ¸: ê±°ë˜ì²˜ ëª©ë¡
- í–‰ ìˆ˜: 98í–‰ (í—¤ë” 4í–‰ + ë°ì´í„° 94í–‰)
- ì»¬ëŸ¼: 17ê°œ (ìˆœë²ˆ, ê±°ë˜ì²˜ë“±ë¡ë²ˆí˜¸, ì¢…ì‚¬ì—…ì¥ë²ˆí˜¸, ê±°ë˜ì²˜ìƒí˜¸, ëŒ€í‘œìëª…, ì‚¬ì—…ìì£¼ì†Œ, ì—…íƒœ, ì¢…ëª©, ë¶€ì„œëª…, ì„±ëª…, ì „í™”ë²ˆí˜¸, íœ´ëŒ€ì „í™”ë²ˆí˜¸, íŒ©ìŠ¤ë²ˆí˜¸, ì´ë©”ì¼ì£¼ì†Œ, ë¹„ê³ , êµ¬ë¶„, ë“±ë¡ì¼ì)

**ë°ì´í„° í’ˆì§ˆ í˜„í™©:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í•­ëª©               â”‚ ê±´ìˆ˜  â”‚ ë¹„ìœ¨    â”‚ ì„¸ê¸ˆê³„ì‚°ì„œ ì˜í–¥   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì´ ê±°ë˜ì²˜          â”‚ 94    â”‚ 100%    â”‚                   â”‚
â”‚ ì‚¬ì—…ìë²ˆí˜¸ ìˆìŒ    â”‚ 94    â”‚ 100%    â”‚ âœ… í•„ìˆ˜ ì¶©ì¡±      â”‚
â”‚ ëŒ€í‘œìëª… ìˆìŒ      â”‚ 92    â”‚ 98%     â”‚ âœ… ê±°ì˜ ì¶©ì¡±      â”‚
â”‚ ì´ë©”ì¼ ìˆìŒ        â”‚ 76    â”‚ 81%     â”‚ âš ï¸ 19% ë°œì†¡ ë¶ˆê°€ â”‚
â”‚ ì£¼ì†Œ ìˆìŒ          â”‚ 20    â”‚ 21%     â”‚ âš ï¸ 79% ëˆ„ë½      â”‚
â”‚ ì—°ë½ì²˜ ìˆìŒ        â”‚ 0     â”‚ 0%      â”‚ âŒ ì „ì²´ ëˆ„ë½      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¬¸ì œì :**
- ë™ì¼í•œ ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ê°€ì§„ í–‰ì´ ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆìŒ (ì˜ˆ: ë³¸ì‚¬ 1ê°œ ì‚¬ì—…ìë¡œ ì—¬ëŸ¬ ì§€ì  ìš´ì˜)
- **ì£¼ì†Œ 21%**: ëŒ€ë¶€ë¶„ ëˆ„ë½ â†’ ì„¸ê¸ˆê³„ì‚°ì„œ ì£¼ì†Œë€ ê³µë°±
- **ì—°ë½ì²˜ 0%**: ì „ì²´ ëˆ„ë½ â†’ ë‹´ë‹¹ì ì—°ë½ ë¶ˆê°€
- **ì´ë©”ì¼ 81%**: 19%ëŠ” ì„¸ê¸ˆê³„ì‚°ì„œ ë°œì†¡ ë¶ˆê°€

### 2.2 í™ˆíƒìŠ¤ ì–‘ì‹ ìš”êµ¬ì‚¬í•­ (ì„¸ê¸ˆê³„ì‚°ì„œë“±ë¡ì–‘ì‹.xls)
ì„¸ê¸ˆê³„ì‚°ì„œ ë°œê¸‰ì„ ìœ„í•œ í•„ìˆ˜ ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

| êµ¬ë¶„ | í•„ìˆ˜ | í•„ë“œëª… | ë§¤í•‘ ì†ŒìŠ¤ (DB) |
|------|------|--------|----------------|
| **ê³µê¸‰ë°›ëŠ” ì** | âœ… | ë“±ë¡ë²ˆí˜¸ | `Customer.businessNo` |
| | âœ… | ìƒí˜¸ | `Customer.name` |
| | âœ… | ì„±ëª…(ëŒ€í‘œì) | `Customer.representative` |
| | - | ì‚¬ì—…ì¥ì£¼ì†Œ | `Customer.address` |
| | - | ì—…íƒœ/ì¢…ëª© | `Customer.category` (Optional) |
| | âœ… | ì´ë©”ì¼ | `Customer.contactEmail` |
| **ê±°ë˜ ë‚´ì—­** | âœ… | ì‘ì„±ì¼ì | ì •ì‚° ë§ˆê°ì¼ |
| | âœ… | ê³µê¸‰ê°€ì•¡ | `Settlement.amount` |
| | âœ… | ì„¸ì•¡ | `SupplyAmount * 0.1` |
| | - | í’ˆëª©/ë¹„ê³  | "1ì›” ë§ˆì¼€íŒ… ëŒ€í–‰ë£Œ" ë“± |

---

## 3. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì œì•ˆ

### 3.1 í”„ë¡œì„¸ìŠ¤ íë¦„ë„ (Data Flow)

```mermaid
graph TD
    A[Raw Data (ê±°ë˜ì²˜ëª©ë¡.xls)] -->|1. Upload & Parse| B(Staging Area)
    B -->|2. Normalize| C{ì‚¬ì—…ìë²ˆí˜¸ ì¤‘ë³µ?}
    C -->|Yes| D[Merge to Single Customer]
    C -->|No| E[Create New Customer]
    D --> F[Mapping Stores]
    E --> F
    F --> G[(ERP DB: Customers/Stores)]
    
    H[Monthly Settlements] -->|3. Aggregate| G
    G -->|4. Generate| I[HomeTax Excel (.xls)]
    I -->|5. Upload| J[HomeTax]
```

### 3.2 í•µì‹¬ ë¡œì§: ì •ê·œí™” (Normalization)

ë°ì´í„°ë¥¼ DBë¡œ ê°€ì ¸ì˜¬ ë•Œ(Import) ë‹¤ìŒ ë¡œì§ì„ ì ìš©í•©ë‹ˆë‹¤.

1. **ì‚¬ì—…ìë²ˆí˜¸ ê¸°ì¤€ ê·¸ë£¹í•‘ (Grouping):**
   - ì—‘ì…€ì˜ ëª¨ë“  í–‰ì„ `ì‚¬ì—…ìë²ˆí˜¸`ë¡œ ê·¸ë£¹í™”í•©ë‹ˆë‹¤.
   - ì˜ˆ: "ê°•ë‚¨ì (123-45-67890)"ê³¼ "í™ëŒ€ì (123-45-67890)" -> **í•˜ë‚˜ì˜ ê³ ê°ì‚¬**ë¡œ í†µí•©.

2. **ëŒ€í‘œ ì •ë³´ ì„ ì •:**
   - ìƒí˜¸ëª… ê²°ì •:
     - ì¤‘ë³µëœ ê²½ìš°, ê°€ì¥ 'ë²•ì¸ìŠ¤ëŸ¬ìš´' ì´ë¦„ì„ ì„ íƒí•˜ê±°ë‚˜ ì‚¬ìš©ìê°€ ëŒ€í‘œ ì´ë¦„ ì§€ì •.
     - ì˜ˆ: "ABCí”„ëœì°¨ì´ì¦ˆ" vs "ABCê°•ë‚¨ì " -> "ABCí”„ëœì°¨ì´ì¦ˆ" ì„ íƒ.

3. **ìë™ ë§¤í•‘ (Auto-Link):**
   - ìƒì„±ëœ `Customer` IDë¥¼ í•´ë‹¹ ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ê°€ì§„ ëª¨ë“  `Store`ì˜ `customerId` í•„ë“œì— ì—°ê²°í•©ë‹ˆë‹¤.

---

## 4. êµ¬í˜„ ìƒì„¸ ê°€ì´ë“œ (For Developers)

### 4.1 ì—‘ì…€ íŒŒì„œ ìœ í‹¸ë¦¬í‹° (`lib/excel-parser.ts`)
í™ˆíƒìŠ¤ ì–‘ì‹ì€ ì•”í˜¸í™”ëœ êµ¬í˜• `.xls`ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ìƒì„± ì‹œì—ëŠ” `xlsx` ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ í˜¸í™˜ ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ìˆœìˆ˜ `csv` ìƒì„± í›„ `.xls` í™•ì¥ìë¡œ ì €ì¥í•˜ëŠ” ë°©ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤. (í™ˆíƒìŠ¤ëŠ” íƒ­ êµ¬ë¶„ìë‚˜ HTML Table í˜•ì‹ë„ ì§€ì›í•¨).

### 4.2 API ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„

#### POST `/api/tax-invoices/import-customers`
- **ê¸°ëŠ¥:** ê±°ë˜ì²˜ëª©ë¡ ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ì—¬ `Customer` ë°ì´í„° ì¼ê´„ ìƒì„±/ê°±ì‹ .
- **ë¡œì§:**
  1. ì—‘ì…€ íŒŒì‹±
  2. `businessNo`ë¡œ ê¸°ì¡´ DB ì¡°íšŒ
  3. ì—†ìœ¼ë©´ `INSERT`, ìˆìœ¼ë©´ `UPDATE` (ì˜µì…˜)
  4. ê²°ê³¼ ë¦¬í¬íŠ¸ ë°˜í™˜ (ì‹ ê·œ: 10ê±´, ì—…ë°ì´íŠ¸: 5ê±´, ì˜¤ë¥˜: 2ê±´)

#### GET `/api/tax-invoices/export-hometax`
- **ê¸°ëŠ¥:** íŠ¹ì • ì›”ì˜ ì •ì‚° ë‚´ì—­ì„ í™ˆíƒìŠ¤ ì–‘ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ìš´ë¡œë“œ.
- **íŒŒë¼ë¯¸í„°:** `year`, `month`, `batchId`(ì„ íƒ)
- **ë¡œì§:**
  1. í•´ë‹¹ ì›”ì˜ í™•ì •ëœ ì •ì‚°(`Settlement`) ì¡°íšŒ.
  2. `Customer`ë³„ë¡œ Grouping ë° ê¸ˆì•¡ í•©ì‚°.
  3. í™ˆíƒìŠ¤ ì—‘ì…€ í…œí”Œë¦¿ì— ë°ì´í„° ë§¤í•‘.
  4. íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìŠ¤íŠ¸ë¦¼ ë°˜í™˜.

**ìƒì„¸ ìŠ¤í™:**

```typescript
// Request
interface HometaxExportRequest {
  year: number;
  month: number;
  format?: 'XLS' | 'CSV';  // ê¸°ë³¸: XLS

  // í•„í„°
  customerIds?: string[];   // íŠ¹ì • ê³ ê°ë§Œ
  minAmount?: number;       // ìµœì†Œ ê¸ˆì•¡

  // ì˜µì…˜
  includeZeroAmount?: boolean;  // 0ì› í¬í•¨ (ê¸°ë³¸: false)
  itemNameTemplate?: string;    // í’ˆëª©ëª… í…œí”Œë¦¿ (ê¸°ë³¸: "{month}ì›” ë§ˆì¼€íŒ… ëŒ€í–‰ë£Œ")
}

// Response
interface HometaxExportResponse {
  success: boolean;
  fileUrl: string;
  filename: string;  // "ì„¸ê¸ˆê³„ì‚°ì„œ_2026ë…„01ì›”_94ê±´.xls"
  summary: {
    totalCustomers: number;
    totalSupplyAmount: number;
    totalTaxAmount: number;
    totalAmount: number;
    skipped: {
      count: number;
      reasons: {
        reason: 'NO_EMAIL' | 'NO_BUSINESS_NO' | 'ZERO_AMOUNT';
        count: number;
        customers: string[];
      }[];
    };
  };
}
```

---

## 5. ê²€ì¦ ë° ì—ëŸ¬ ì²˜ë¦¬ (ì‹ ê·œ ì„¹ì…˜)

### 5.1 Import ê²€ì¦ ë¡œì§

```typescript
interface CustomerImportValidation {
  // í•„ìˆ˜ í•„ë“œ
  required: ['businessNo', 'name'];

  // ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ê°€ëŠ¥ ì¡°ê±´
  taxInvoiceReady: {
    required: ['businessNo', 'name', 'email'];
    recommended: ['representative', 'address'];
  };

  // ê²€ì¦ ê²°ê³¼
  validate: (row: ImportRow) => {
    valid: boolean;
    errors: ValidationError[];
    warnings: ValidationWarning[];
  };
}

interface ValidationError {
  field: string;
  type: 'MISSING_REQUIRED' | 'INVALID_FORMAT' | 'DUPLICATE';
  message: string;
}

interface ValidationWarning {
  field: string;
  type: 'MISSING_EMAIL' | 'MISSING_ADDRESS' | 'MISSING_PHONE';
  message: string;
  impact: string;  // "ì„¸ê¸ˆê³„ì‚°ì„œ ë°œì†¡ ë¶ˆê°€" ë“±
}
```

### 5.2 Export ì „ ì²´í¬

```typescript
// ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ì „ í•„ìˆ˜ ì²´í¬
interface PreExportCheck {
  customerId: string;
  customerName: string;
  checks: {
    hasBusinessNo: boolean;
    hasName: boolean;
    hasEmail: boolean;
    hasRepresentative: boolean;
    hasAddress: boolean;
    hasSettlement: boolean;
    settlementAmount: number;
  };
  canExport: boolean;
  blockers: string[];  // ë°œí–‰ ë¶ˆê°€ ì‚¬ìœ 
  warnings: string[];  // ê²½ê³  ì‚¬í•­
}
```

---

## 6. ê²°ë¡  ë° ê¸°ëŒ€íš¨ê³¼

ì´ ì„¤ê³„ë¥¼ í†µí•´ "ë§¤ì¥" ë‹¨ìœ„ë¡œ í©ì–´ì§„ ë°ì´í„°ë¥¼ "ê³¼ê¸ˆ ì£¼ì²´(ê³ ê°)" ë‹¨ìœ„ë¡œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë‹¤ë¥¸ ì—ì´ì „íŠ¸ì™€ í˜‘ì—… ì‹œ, **"ë°ì´í„° Import ì‹œì ì˜ ì¤‘ë³µ ì œê±°(De-duplication)"** ë¡œì§ êµ¬í˜„ì— ì§‘ì¤‘í•´ë‹¬ë¼ê³  ìš”ì²­í•˜ì‹­ì‹œì˜¤.
