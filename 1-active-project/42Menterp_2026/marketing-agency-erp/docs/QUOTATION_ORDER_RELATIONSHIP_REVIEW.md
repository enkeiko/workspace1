# 견적서-주문 관계 검토 보고서

## 현재 문제점 분석

### 1. 현재 스키마 구조
- `Quotation.orders Order[]` - 1:N 관계 (한 견적서에 여러 주문 가능) ✅
- `Order.quotationId Int?` - 선택적 필드 (주문이 견적서에서 생성되었을 수 있음) ✅

### 2. 현재 구현의 문제점

#### 문제 1: 견적서 → 주문 전환 제한
```typescript
// 현재: 이미 주문이 있으면 에러 발생
if (existingOrder) {
  throw new ValidationError("이미 주문으로 전환된 견적서입니다.");
}
```
**문제**: 한 견적서에서 여러 주문을 생성할 수 없음 (1:N 관계인데 1:1로 제한)

#### 문제 2: 주문 → 견적서 전환 제한
```typescript
// 현재: 이미 견적서가 연결되어 있으면 에러 발생
if (order.quotationId) {
  throw new ValidationError("이미 견적서가 연결된 주문입니다.");
}
```
**문제**: 한 주문은 하나의 견적서에만 연결 가능 (N:1 관계는 맞지만, 여러 주문을 하나의 견적서에 연결 불가)

#### 문제 3: 양방향 전환 시나리오 충돌
1. 주문 생성 → 견적서 생성 → 견적서를 다시 주문으로 전환 시도
   - 견적서에 이미 주문이 연결되어 있어서 에러 발생
   - 하지만 원래 주문과 새로 생성된 주문이 충돌

2. 견적서 생성 → 주문 생성 → 주문을 다시 견적서로 전환 시도
   - 주문에 이미 견적서가 연결되어 있어서 에러 발생

### 3. 올바른 비즈니스 로직

#### 시나리오 1: 주문 먼저 생성 → 견적서 생성
- 여러 주문을 선택하여 하나의 견적서로 묶을 수 있어야 함
- 견적서 생성 시 기존 주문들을 연결

#### 시나리오 2: 견적서 생성 → 주문 추가
- 견적서에서 주문으로 전환 시, 기존 주문이 있어도 추가 주문 생성 가능
- 한 견적서에서 여러 주문 생성 가능 (부분 주문, 추가 주문 등)

#### 시나리오 3: 견적서 항목에 주문 추가
- 견적서 작성 시 기존 주문의 항목을 가져와서 견적서 항목으로 추가
- 이 경우 주문과 견적서는 별개 (견적서 항목만 복사)

## 수정 방안

### 방안 1: 견적서 → 주문 전환 제한 제거
- 한 견적서에서 여러 주문 생성 허용
- "이미 주문으로 전환된 견적서입니다" 에러 제거

### 방안 2: 주문 → 견적서 전환 개선
- 여러 주문을 선택하여 하나의 견적서에 연결
- 또는 기존 견적서에 주문 추가

### 방안 3: 견적서 항목에 주문 추가 기능
- 현재 구현됨 ✅
- 주문의 항목을 견적서 항목으로 복사 (주문과 견적서는 별개)

## 권장 수정 사항

1. **견적서 → 주문 전환**: 여러 번 전환 허용 (1:N 관계 활용)
2. **주문 → 견적서 전환**: 여러 주문을 하나의 견적서에 연결 가능하도록 개선
3. **견적서 항목 추가**: 현재 구현 유지 (주문 항목을 견적서 항목으로 복사)

