# Phase 1 기획서 보완 문서 (v1.1)

**프로젝트명**: 42ment 광고대행사 관리 시스템
**Phase**: 1 (MVP)
**버전**: 1.1 보완
**작성일**: 2025-11-14

---

## 📝 개요

이 문서는 `phase1-spec.md` v1.0의 보완 사항을 정의합니다. 20년차 PM 관점의 검토를 통해 발견된 치명적 이슈 및 중요 기능을 추가합니다.

**주요 변경사항**:
- ✅ 고객별 단가 관리 기능 추가
- ✅ 번호 생성 규칙 명확화
- ✅ 감사 로그 기능 추가
- ✅ 알림 관리 기능 추가
- ✅ 세금계산서 유형 관리 강화
- ✅ 미수금 계산 로직 개선
- ✅ 고객 비활성화 기능 추가
- ✅ 계약 갱신 관리 추가

---

## 🎯 추가 기능 요구사항 (Functional Requirements)

### 📋 고객별 단가 관리

**FR-014**: 고객별 특별 단가 설정

**목적**: 고객마다 다른 단가를 적용하여 유연한 가격 정책 지원

**기능**:
- 고객별, 상품 카테고리별 특별 단가 등록
  - 고객 선택
  - 상품 카테고리 선택
  - 특별 단가 입력
  - 유효 기간 설정 (시작일/종료일)
  - 메모
- 고객별 단가 목록 조회
  - 고객별 필터
  - 유효/만료 상태 필터
- 고객별 단가 수정/삭제

**단가 적용 우선순위**:
1. **고객별 특별 단가** (client_product_price)
2. **상품 기본 단가** (product.default_price)
3. **카테고리 기본 단가** (product_category.default_price)

**유효성 검증**:
- 같은 고객, 같은 카테고리에 대해 기간이 겹치는 단가 등록 불가
- 시작일 < 종료일 검증
- 종료일 NULL 허용 (무기한 유효)

**UI 위치**:
- 고객 상세 화면 → "특별 단가" 탭
- 견적서/주문 생성 시 자동 적용

---

### 🔢 번호 자동 생성 시스템

**FR-094**: 견적서/주문/세금계산서 번호 자동 생성

**목적**: 일관된 번호 체계와 중복 방지

**포맷**:
- 견적서: `Q-YYYYMM-XXX` (예: Q-202511-001)
- 주문: `O-YYYYMM-XXX` (예: O-202511-001)
- 세금계산서: `I-YYYYMM-XXX` (예: I-202511-001)
  - 수정: `I-202511-001-M1` (M = Modified)
  - 취소: `I-202511-001-C` (C = Cancelled)

**생성 규칙**:
1. 월별로 번호 리셋 (매월 1일 001부터 시작)
2. 3자리 일련번호 (001~999)
3. 999 초과 시 4자리로 자동 확장
4. 트랜잭션 락으로 동시성 제어

**구현 방식**:
- `sequence_counter` 테이블 사용
- SELECT FOR UPDATE로 동시성 제어
- 애플리케이션 레벨에서 포맷팅

**사용자 경험**:
- 견적서/주문/세금계산서 생성 시 자동으로 번호 부여
- 번호는 수정 불가 (읽기 전용)
- 생성 전 미리보기: "다음 번호: Q-202511-015"

---

### 📊 감사 로그 (Audit Log)

**FR-095**: 중요 데이터 변경 이력 기록

**목적**: 데이터 변경 투명성 확보 및 추적

**로그 대상**:
- **필수**: Quote, Order, Invoice, Payment
- **권장**: Client (연락처 변경), Contract (금액 변경)

**로그 내용**:
- 테이블명 (table_name)
- 레코드 ID (record_id)
- 작업 유형 (INSERT/UPDATE/DELETE)
- 변경된 필드명 (field_name)
- 이전 값 (old_value)
- 새 값 (new_value)
- 변경자 (user_id)
- 변경자 IP (user_ip)
- 변경 시각 (created_at)

**조회 기능**:
- 테이블별 변경 이력
- 레코드별 변경 이력
- 사용자별 변경 이력
- 기간별 변경 이력
- 필터: 작업 유형, 테이블명

**UI 위치**:
- 견적서/주문/세금계산서 상세 화면 → "변경 이력" 버튼
- 관리자 메뉴 → "감사 로그"

**권한**:
- 관리자만 조회 가능
- 수정/삭제 불가 (immutable)

---

### 🔔 알림 관리

**FR-096**: 계약 만료, 계정 만료 등 알림 관리

**목적**: 중요한 일정을 놓치지 않도록 사전 알림

**알림 유형**:

**1. 계약 만료 알림**:
- D-30 (30일 전)
- D-7 (7일 전)
- D-Day (당일)

**2. 광고 계정 만료 알림**:
- D-30 (30일 전)
- D-7 (7일 전)
- D-Day (당일)

**알림 기능**:
- 알림 목록 조회
  - 읽지 않은 알림 우선 표시
  - 우선순위별 정렬 (high > normal > low)
- 알림 상세 조회
- 알림 읽음 처리
  - 개별 읽음 처리
  - 전체 읽음 처리
- 알림 삭제

**UI 표시**:
- 상단 네비게이션 바: 알림 아이콘 + 뱃지 (읽지 않은 개수)
- 대시보드: 중요 알림 카드
- 알림 센터: 전체 알림 목록

**알림 생성**:
- 배치 작업 (매일 새벽 실행)
- 중복 알림 방지 (같은 날 같은 항목에 대해 1번만)

---

### 💰 세금계산서 유형 관리 (FR-060 개선)

**FR-060-1**: 정상/수정/취소 세금계산서 관리

**목적**: 세금계산서 수정 및 취소 프로세스 지원

**세금계산서 유형**:

**1. 정상 발행 (normal)**:
- 일반적인 세금계산서 발행
- 주문당 1개만 발행 가능
- 중복 발행 시 오류

**2. 수정 발행 (modified)**:
- 기존 세금계산서의 내용 수정
- 원본 세금계산서 지정 필수
- 원본이 입금 완료('Y')이면 수정 불가
- 번호 형식: `I-202511-001-M1`

**3. 취소 발행 (cancelled)**:
- 기존 세금계산서 취소
- 원본 세금계산서 지정 필수
- 원본이 입금 완료('Y')이면 취소 불가
- 금액은 음수로 기록
- 번호 형식: `I-202511-001-C`

**발행 프로세스**:
```
[정상 발행]
1. 주문 선택
2. 중복 체크 (order_id에 normal 세금계산서 있는지)
3. 세금계산서 생성
4. invoice_type = 'normal'

[수정 발행]
1. 원본 세금계산서 선택
2. 입금 상태 체크 (is_paid = 'N'인지)
3. 수정 세금계산서 생성
4. invoice_type = 'modified'
5. original_invoice_id = 원본 ID
6. 번호에 -M1, -M2 등 추가

[취소 발행]
1. 원본 세금계산서 선택
2. 입금 상태 체크 (is_paid = 'N'인지)
3. 취소 세금계산서 생성
4. invoice_type = 'cancelled'
5. original_invoice_id = 원본 ID
6. 금액을 음수로
7. 번호에 -C 추가
```

---

### 💸 입금 관리 개선 (FR-061 개선)

**FR-061-1**: 부분 입금 및 paid_amount 자동 계산

**목적**: 정확한 미수금 계산 및 부분 입금 지원

**개선 사항**:

**1. paid_amount 자동 계산**:
- Invoice 테이블에 `paid_amount` 필드 추가
- Payment INSERT/UPDATE/DELETE 시 자동 갱신 (트리거)
- `paid_amount = SUM(payment.amount WHERE invoice_id = X)`

**2. is_paid 자동 업데이트**:
- `is_paid = (paid_amount >= total) ? 'Y' : 'N'`
- 부분 입금 시 'N' 유지
- 완전 입금 시 자동으로 'Y'

**3. 입금 연결 방식**:

**방식 A: 세금계산서에 직접 연결**
```
Payment.invoice_id = 특정 세금계산서 ID
→ 해당 세금계산서의 paid_amount에 자동 반영
```

**방식 B: 고객에게만 연결**
```
Payment.invoice_id = NULL
Payment.client_id = 특정 고객 ID
→ 고객 전체 미수금에는 반영되지만
→ 어느 세금계산서에 적용할지는 수동 매칭 필요
```

**4. 초과 입금 (선수금) 처리**:
```
paid_amount > total인 경우:
→ 선수금으로 표시
→ 다른 세금계산서에 적용 가능
```

---

### 📉 미수금 계산 개선 (FR-062 개선)

**FR-062-1**: 정확한 미수금 계산 로직

**목적**: 부분 입금을 고려한 정확한 미수금 산출

**계산 방식**:

**세금계산서별 미수금**:
```sql
미수금 = invoice.total - invoice.paid_amount

WHERE invoice_type = 'normal' -- 정상 세금계산서만
```

**고객별 미수금**:
```sql
고객 미수금 = SUM(invoice.total - invoice.paid_amount)

WHERE client_id = X
  AND invoice_type = 'normal'
```

**전체 미수금**:
```sql
전체 미수금 = SUM(invoice.total - invoice.paid_amount)

WHERE invoice_type = 'normal'
```

**미수금 현황 화면**:
- 고객별 미수금 목록
- 세금계산서별 입금 상태
  - 미입금: paid_amount = 0
  - 부분 입금: 0 < paid_amount < total
  - 완료: paid_amount >= total
- 경과 기간별 필터 (D+30, D+60, D+90)

---

### 👤 고객 상태 관리 (FR-010 확장)

**FR-010-1**: 고객 비활성화 기능

**목적**: 거래 중단 고객을 삭제하지 않고 비활성화

**고객 상태**:
- `active`: 활성 (거래 중)
- `inactive`: 비활성 (거래 중단)
- `suspended`: 정지 (일시적 중단)

**비활성화 프로세스**:
1. 고객 상세 화면 → "비활성화" 버튼
2. 비활성화 사유 입력 (필수)
3. 확인 시:
   - status = 'inactive'
   - deactivated_at = 현재 시각
   - deactivation_reason = 입력한 사유

**비활성 고객 처리**:
- 목록 조회 시 기본적으로 제외
- "비활성 고객 포함" 옵션으로 조회 가능
- 새 견적/주문 생성 시 선택 불가
- 기존 데이터 (주문, 세금계산서 등)는 정상 조회 가능

**재활성화**:
- 비활성 고객 상세 화면 → "재활성화" 버튼
- 확인 시:
   - status = 'active'
   - deactivated_at = NULL
   - deactivation_reason = NULL (또는 보존)

---

### 📜 계약 갱신 관리 (FR-050 확장)

**FR-050-1**: 계약 갱신 히스토리 관리

**목적**: 계약 갱신 이력 추적 및 자동 갱신 지원

**추가 필드**:
- `parent_contract_id`: 이전 계약 ID (갱신된 계약인 경우)
- `is_auto_renewal`: 자동 갱신 여부 (Y/N)
- `renewal_count`: 갱신 횟수

**계약 갱신 프로세스**:

**수동 갱신**:
1. 기존 계약 상세 화면 → "계약 갱신" 버튼
2. 새 계약 정보 입력
   - 계약명: 자동 생성 (기존 계약명 + "(2차)")
   - 시작일: 기존 종료일 + 1일
   - 종료일: 입력
   - 계약 금액: 기존 금액 복사 (수정 가능)
3. 저장 시:
   - 새 계약 생성
   - parent_contract_id = 기존 계약 ID
   - renewal_count = 기존 계약 renewal_count + 1

**자동 갱신** (Phase 2):
- is_auto_renewal = 'Y'인 계약
- 만료 D-30에 자동 갱신 알림
- 사용자 확인 후 자동 생성

**갱신 이력 조회**:
- 계약 상세 화면 → "갱신 이력" 탭
- 이전 계약들 목록 표시
- 각 계약 기간, 금액, 갱신 횟수

---

## 👤 추가 사용자 스토리

### Story 6: 고객별 단가 설정 및 적용
**우선순위**: P2 (우선)

**As a** 광고대행사 운영자
**I want to** 특정 고객에게 특별 단가를 설정하고 견적서에 자동 적용하고
**So that** 고객마다 다른 가격 정책을 쉽게 관리할 수 있다

**Acceptance Criteria**:
1. **Given** 고객이 등록된 상태에서, **When** 고객 상세 화면에서 "특별 단가" 탭으로 이동하고 블로그 카테고리에 대해 특별 단가를 설정하면, **Then** 고객별 단가 목록에 추가된다
2. **Given** 고객별 단가가 설정된 상태에서, **When** 해당 고객에게 견적서를 생성하고 블로그 상품을 선택하면, **Then** 특별 단가가 자동으로 적용된다
3. **Given** 고객별 단가가 만료된 상태에서, **When** 견적서를 생성하면, **Then** 기본 단가가 적용된다

---

### Story 7: 세금계산서 수정 및 취소
**우선순위**: P2 (우선)

**As a** 광고대행사 운영자
**I want to** 발행한 세금계산서를 수정하거나 취소하고
**So that** 오류 발생 시 적법하게 처리할 수 있다

**Acceptance Criteria**:
1. **Given** 정상 세금계산서가 발행되고 입금되지 않은 상태에서, **When** "수정 세금계산서 발행" 버튼을 클릭하고 금액을 수정하면, **Then** 수정 세금계산서가 생성되고 번호에 -M1이 추가된다
2. **Given** 정상 세금계산서가 발행되고 입금된 상태에서, **When** "수정 세금계산서 발행" 버튼을 클릭하면, **Then** "입금 완료된 세금계산서는 수정할 수 없습니다" 오류 메시지가 표시된다
3. **Given** 정상 세금계산서가 발행된 상태에서, **When** "취소 세금계산서 발행" 버튼을 클릭하면, **Then** 금액이 음수인 취소 세금계산서가 생성된다

---

### Story 8: 알림 확인 및 관리
**우선순위**: P3 (선택)

**As a** 광고대행사 운영자
**I want to** 계약 만료 및 계정 만료 알림을 확인하고
**So that** 중요한 일정을 놓치지 않을 수 있다

**Acceptance Criteria**:
1. **Given** 계약 만료가 7일 남은 상태에서, **When** 대시보드를 열면, **Then** "계약 만료 알림" 카드에 해당 계약이 표시된다
2. **Given** 읽지 않은 알림이 3개 있는 상태에서, **When** 상단 네비게이션 바의 알림 아이콘을 확인하면, **Then** 뱃지에 "3"이 표시된다
3. **Given** 알림 센터에서, **When** 특정 알림을 클릭하여 읽으면, **Then** 해당 알림이 읽음 상태로 변경되고 뱃지 숫자가 감소한다

---

## ✅ 추가 성공 기준

**SC-006**: 고객별 단가 적용 자동화
- 고객별 단가 설정 후 견적서 생성 시 **자동 적용률 95% 이상**

**SC-007**: 감사 로그 무결성
- 모든 금액 관련 데이터 변경이 **100% 로그에 기록**됨

**SC-008**: 알림 정확도
- 계약 만료 D-7 알림이 **정확한 날짜에 100% 생성**됨

**SC-009**: 세금계산서 중복 방지
- 주문당 정상 세금계산서 **중복 발행 0건**

**SC-010**: 미수금 계산 정확도
- 부분 입금을 고려한 미수금 계산이 **100% 정확**함

---

## 🔒 추가 가정 사항

**A-009**: 감사 로그 보관
- Phase 1에서는 무기한 보관
- Phase 2에서 보관 정책 수립 (예: 5년)

**A-010**: 알림 생성 시점
- 배치 작업으로 매일 새벽 실행
- 실시간 알림은 Phase 2

**A-011**: 고객별 단가 히스토리
- 과거 단가는 삭제하지 않고 보존
- 견적서/주문의 가격 근거로 활용

---

## 🚫 추가 제약 사항

**C-006**: 감사 로그 용량
- 로그 데이터 증가 고려
- 필요 시 파티셔닝 또는 아카이빙 (Phase 2)

**C-007**: 번호 생성 동시성
- 트랜잭션 락으로 인한 대기 시간 발생 가능
- 일반적으로 1초 이내 처리

---

## 🎯 개발 우선순위 조정

### Sprint 2 (2주): 내정보 및 고객 관리 - 업데이트
- [ ] 내정보 관리 (회사 정보, 계좌)
- [ ] 고객 CRUD
- [ ] 고객 목록 조회 및 검색
- [ ] 광고 계정 정보 CRUD (고객 연동)
- [ ] 보고서 발송 정보 관리 (고객 연동)
- [ ] **⭐ 고객 상태 관리 (비활성화)** - NEW
- [ ] **⭐ 고객별 단가 설정** - NEW

### Sprint 3 (2주): 매장 및 상품 관리 - 업데이트
- [ ] 매장 CRUD
- [ ] 매장 목록 조회 (고객별 필터)
- [ ] 상품 카테고리 관리
- [ ] (선택) 상품 관리
- [ ] **⭐ 번호 생성 시스템 구축** - NEW

### Sprint 4 (3주): 견적/주문 관리 - 업데이트
- [ ] 견적서 생성 및 PDF 다운로드
  - [ ] **고객별 단가 자동 적용** - NEW
- [ ] 견적서 목록 및 상태 관리
- [ ] 주문 등록 (견적 전환 + 직접 등록)
- [ ] 주문 목록 조회 (필터/검색)
- [ ] 주문 상태 관리
- [ ] **⭐ 감사 로그 트리거 (Quote, Order)** - NEW

### Sprint 5 (2주): 계약서 관리 - 업데이트
- [ ] 계약서 파일 업로드
- [ ] 계약 정보 CRUD
- [ ] 계약 만료 알림 로직
- [ ] **⭐ 계약 갱신 기능** - NEW

### Sprint 6 (3주): 정산 관리 - 업데이트
- [ ] 세금계산서 CRUD
  - [ ] **세금계산서 유형 관리 (정상/수정/취소)** - NEW
  - [ ] **중복 발행 방지 로직** - NEW
- [ ] 입금 CRUD
  - [ ] **paid_amount 자동 계산 트리거** - NEW
- [ ] 세금계산서-입금 매칭
- [ ] **⭐ 미수금 현황 조회 (개선된 로직)** - UPDATED
- [ ] 매출 요약 (고객별, 기간별)
- [ ] **⭐ 감사 로그 트리거 (Invoice, Payment)** - NEW

### Sprint 8 (1주): 대시보드 및 공통 기능 - 업데이트
- [ ] 대시보드 (매출 요약, 알림)
  - [ ] **⭐ 알림 카드 (계약 만료, 계정 만료)** - NEW
- [ ] 데이터 다운로드 (CSV/Excel)
- [ ] 파일 업로드 공통 기능
- [ ] **⭐ 알림 센터** - NEW
- [ ] **⭐ 알림 배치 작업** - NEW
- [ ] **⭐ 감사 로그 조회 화면** - NEW

---

## 📚 다음 단계 (우선순위)

1. **✅ 비즈니스 룰 문서 검토** (`business-rules.md`)
2. **✅ 데이터 스키마 v1.1 검토** (`data-model-v1.1.md`)
3. **⬜ 파일 관리 정책 작성** (`file-management-policy.md`)
4. **⬜ API 명세서 작성** (`contracts/api-spec.md`)
5. **⬜ UI/UX 와이어프레임** (주요 화면 중심)
6. **⬜ Sprint 1 착수**

---

## 📊 변경 사항 요약

### 새로 추가된 기능 (8개)
1. ✅ 고객별 단가 관리
2. ✅ 번호 자동 생성 시스템
3. ✅ 감사 로그
4. ✅ 알림 관리
5. ✅ 세금계산서 유형 관리 (수정/취소)
6. ✅ 고객 비활성화
7. ✅ 계약 갱신 관리
8. ✅ 미수금 계산 개선

### 새로 추가된 테이블 (4개)
1. `client_product_price` (고객별 단가)
2. `sequence_counter` (번호 관리)
3. `audit_log` (감사 로그)
4. `notification` (알림)

### 수정된 테이블 (3개)
1. `client`: status, deactivated_at 등 추가
2. `invoice`: paid_amount, invoice_type, original_invoice_id 추가
3. `contract`: parent_contract_id, is_auto_renewal 등 추가

### 추가된 사용자 스토리 (3개)
1. Story 6: 고객별 단가 설정 및 적용
2. Story 7: 세금계산서 수정 및 취소
3. Story 8: 알림 확인 및 관리

---

**문서 버전**: 1.1 보완
**최종 수정일**: 2025-11-14
**작성자**: Claude (PM)
**검토자**: (검토 필요)
**참조 문서**:
- `phase1-spec.md` (v1.0 원본)
- `business-rules.md` (v1.1)
- `data-model-v1.1.md` (v1.1)
