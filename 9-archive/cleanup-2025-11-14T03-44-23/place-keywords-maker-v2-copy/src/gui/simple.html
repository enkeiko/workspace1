<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Place Keywords Maker V2</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
    }
    h1 { color: #667eea; margin-bottom: 20px; }
    .input-section {
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      min-height: 150px;
      font-family: 'Courier New', monospace;
    }
    button {
      padding: 15px 30px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .results {
      margin-top: 30px;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log {
      padding: 8px;
      margin: 5px 0;
      border-left: 3px solid #667eea;
      background: white;
    }
    .success { border-color: #48bb78; color: #22543d; }
    .error { border-color: #f56565; color: #742a2a; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Place Keywords Maker V2</h1>

    <div class="input-section">
      <label for="placeIds">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ID ì…ë ¥ (í•œ ì¤„ì— í•˜ë‚˜ì”©):</label>
      <textarea id="placeIds" placeholder="ì˜ˆì‹œ:
1768171911
1265317185
1575722042">1768171911</textarea>
    </div>

    <button id="startBtn" onclick="start()">â–¶ L1 í¬ë¡¤ë§ ì‹œì‘</button>

    <div class="results" id="results" style="display:none">
      <h3>ğŸ“‹ ì²˜ë¦¬ ê²°ê³¼</h3>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    let eventSource = null;

    // SSE ì—°ê²°
    function connectSSE() {
      if (eventSource) return;

      eventSource = new EventSource('/events');

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleServerEvent(data);
      };

      eventSource.onerror = () => {
        console.log('SSE ì—°ê²° ëŠê¹€. ì¬ì—°ê²° ì¤‘...');
        eventSource.close();
        eventSource = null;
        setTimeout(connectSSE, 3000);
      };
    }

    // ì„œë²„ ì´ë²¤íŠ¸ ì²˜ë¦¬
    function handleServerEvent(data) {
      const btn = document.getElementById('startBtn');

      switch(data.type) {
        case 'connected':
          console.log('ì„œë²„ ì—°ê²°ë¨');
          break;

        case 'start':
          addLog(data.message);
          break;

        case 'progress':
          addLog(data.message);
          break;

        case 'success':
          addLog(data.message, 'success');
          break;

        case 'error':
          addLog(data.message, 'error');
          break;

        case 'complete':
          addLog(data.message, 'success');
          btn.disabled = false;
          btn.textContent = 'â–¶ L1 í¬ë¡¤ë§ ì‹œì‘';
          break;
      }
    }

    // í¬ë¡¤ë§ ì‹œì‘
    async function start() {
      const textarea = document.getElementById('placeIds');
      const btn = document.getElementById('startBtn');
      const resultsDiv = document.getElementById('results');
      const logsDiv = document.getElementById('logs');

      const ids = textarea.value
        .split('\n')
        .map(line => line.trim())
        .filter(id => id && /^\d+$/.test(id));

      if (ids.length === 0) {
        alert('ìœ íš¨í•œ Place IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'â³ ì²˜ë¦¬ ì¤‘...';
      resultsDiv.style.display = 'block';
      logsDiv.innerHTML = '';

      addLog(`ğŸ“‹ ${ids.length}ê°œ ë§¤ì¥ ì²˜ë¦¬ ìš”ì²­ ì¤‘...`);

      try {
        // API í˜¸ì¶œ
        const response = await fetch('/api/process', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ placeIds: ids }),
        });

        const result = await response.json();

        if (result.success) {
          addLog(`âœ… ${result.message}`, 'success');
        } else {
          addLog(`âŒ ${result.error}`, 'error');
          btn.disabled = false;
          btn.textContent = 'â–¶ L1 í¬ë¡¤ë§ ì‹œì‘';
        }
      } catch (error) {
        addLog(`âŒ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'â–¶ L1 í¬ë¡¤ë§ ì‹œì‘';
      }
    }

    function addLog(message, type = '') {
      const logsDiv = document.getElementById('logs');
      const log = document.createElement('div');
      log.className = `log ${type}`;
      log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.insertBefore(log, logsDiv.firstChild);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ SSE ì—°ê²°
    window.onload = () => {
      connectSSE();
      addLog('âœ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };
  </script>
</body>
</html>
