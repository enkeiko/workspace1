// Prisma Schema for 42ment ERP System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. 회사 정보
model CompanyInfo {
  id                        Int       @id @default(autoincrement())
  companyName               String    @map("company_name") @db.VarChar(255)
  ceoName                   String?   @map("ceo_name") @db.VarChar(100)
  businessNumber            String?   @unique @map("business_number") @db.VarChar(50)
  address                   String?
  phone                     String?   @db.VarChar(20)
  email                     String?   @db.VarChar(255)
  businessRegistrationFile  String?   @map("business_registration_file") @db.VarChar(500)
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")
  createdBy                 String    @default("admin") @map("created_by") @db.VarChar(50)

  @@map("company_info")
}

// 2. 은행 계좌
model BankAccount {
  id             Int       @id @default(autoincrement())
  bankName       String    @map("bank_name") @db.VarChar(100)
  accountNumber  String    @map("account_number") @db.VarChar(50)
  accountHolder  String    @map("account_holder") @db.VarChar(100)
  isDefault      String    @default("N") @map("is_default") @db.Char(1)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  payments       Payment[]

  @@map("bank_account")
}

// 3. 고객
model Client {
  id                   Int       @id @default(autoincrement())
  companyName          String    @map("company_name") @db.VarChar(255)
  ceoName              String    @map("ceo_name") @db.VarChar(100)
  contactName          String    @map("contact_name") @db.VarChar(100)
  phone                String    @db.VarChar(20)
  email                String?   @db.VarChar(255)
  businessNumber       String?   @map("business_number") @db.VarChar(50)
  address              String?
  memo                 String?
  status               String    @default("active") @db.VarChar(20)
  reportFrequency      String?   @map("report_frequency") @db.VarChar(20)
  reportDay            String?   @map("report_day") @db.VarChar(10)
  reportEmails         String?   @map("report_emails") @db.VarChar(500)
  reportTemplate       String?   @map("report_template") @db.VarChar(100)
  reportEnabled        String    @default("N") @map("report_enabled") @db.Char(1)
  deactivatedAt        DateTime? @map("deactivated_at")
  deactivationReason   String?   @map("deactivation_reason")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  stores               Store[]
  adAccounts           AdAccount[]
  clientProductPrices  ClientProductPrice[]
  quotes               Quote[]
  orders               Order[]
  contracts            Contract[]
  invoices             Invoice[]
  payments             Payment[]
  reports              Report[]

  @@map("client")
}

// 4. 광고 계정
model AdAccount {
  id           Int       @id @default(autoincrement())
  clientId     Int       @map("client_id")
  platform     String    @db.VarChar(50)
  accountId    String    @map("account_id") @db.VarChar(100)
  password     String?   @db.VarChar(255)
  apiKey       String?   @map("api_key") @db.VarChar(500)
  accessLevel  String?   @map("access_level") @db.VarChar(50)
  expiryDate   DateTime? @map("expiry_date") @db.Date
  status       String    @default("active") @db.VarChar(20)
  memo         String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  client       Client    @relation(fields: [clientId], references: [id])

  @@map("ad_account")
}

// 5. 매장
model Store {
  id           Int       @id @default(autoincrement())
  clientId     Int       @map("client_id")
  storeName    String    @map("store_name") @db.VarChar(255)
  address      String?
  businessType String?   @map("business_type") @db.VarChar(50)
  phone        String?   @db.VarChar(20)
  memo         String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  client       Client    @relation(fields: [clientId], references: [id])
  quotes       Quote[]
  orders       Order[]
  contracts    Contract[]
  reports      Report[]

  @@map("store")
}

// 6. 상품 카테고리
model ProductCategory {
  id                  Int       @id @default(autoincrement())
  categoryName        String    @map("category_name") @db.VarChar(100)
  defaultPrice        Decimal   @map("default_price") @db.Decimal(12, 2)
  description         String?   @db.VarChar(500)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  clientProductPrices ClientProductPrice[]

  @@map("product_category")
}

// 7. 고객별 특별 단가
model ClientProductPrice {
  id                Int       @id @default(autoincrement())
  clientId          Int       @map("client_id")
  productCategoryId Int       @map("product_category_id")
  customPrice       Decimal   @map("custom_price") @db.Decimal(12, 2)
  effectiveFrom     DateTime  @map("effective_from") @db.Date
  effectiveUntil    DateTime? @map("effective_until") @db.Date
  memo              String?   @db.VarChar(500)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  client            Client          @relation(fields: [clientId], references: [id])
  productCategory   ProductCategory @relation(fields: [productCategoryId], references: [id])

  @@unique([clientId, productCategoryId, effectiveFrom])
  @@map("client_product_price")
}

// 8. 견적서
model Quote {
  id           Int       @id @default(autoincrement())
  quoteNumber  String    @unique @map("quote_number") @db.VarChar(50)
  clientId     Int       @map("client_id")
  storeId      Int?      @map("store_id")
  quoteDate    DateTime  @map("quote_date") @db.Date
  status       String    @default("pending") @db.VarChar(20)
  subtotal     Decimal   @db.Decimal(12, 2)
  vat          Decimal   @db.Decimal(12, 2)
  total        Decimal   @db.Decimal(12, 2)
  vatIncluded  String    @default("N") @map("vat_included") @db.Char(1)
  memo         String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  client       Client     @relation(fields: [clientId], references: [id])
  store        Store?     @relation(fields: [storeId], references: [id])
  items        QuoteItem[]
  order        Order?

  @@map("quote")
}

// 9. 견적 품목
model QuoteItem {
  id          Int       @id @default(autoincrement())
  quoteId     Int       @map("quote_id")
  productName String    @map("product_name") @db.VarChar(255)
  quantity    Int
  unitPrice   Decimal   @map("unit_price") @db.Decimal(12, 2)
  subtotal    Decimal   @db.Decimal(12, 2)
  memo        String?   @db.VarChar(500)
  createdAt   DateTime  @default(now()) @map("created_at")

  quote       Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_item")
}

// 10. 주문
model Order {
  id           Int       @id @default(autoincrement())
  orderNumber  String    @unique @map("order_number") @db.VarChar(50)
  clientId     Int       @map("client_id")
  storeId      Int?      @map("store_id")
  quoteId      Int?      @unique @map("quote_id")
  orderDate    DateTime  @map("order_date") @db.Date
  deliveryDate DateTime? @map("delivery_date") @db.Date
  status       String    @default("pending") @db.VarChar(20)
  subtotal     Decimal   @db.Decimal(12, 2)
  vat          Decimal   @db.Decimal(12, 2)
  total        Decimal   @db.Decimal(12, 2)
  vatIncluded  String    @default("N") @map("vat_included") @db.Char(1)
  memo         String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  client       Client     @relation(fields: [clientId], references: [id])
  store        Store?     @relation(fields: [storeId], references: [id])
  quote        Quote?     @relation(fields: [quoteId], references: [id])
  items        OrderItem[]
  invoices     Invoice[]

  @@map("sales_order")
}

// 11. 주문 품목
model OrderItem {
  id          Int       @id @default(autoincrement())
  orderId     Int       @map("order_id")
  productName String    @map("product_name") @db.VarChar(255)
  quantity    Int
  unitPrice   Decimal   @map("unit_price") @db.Decimal(12, 2)
  subtotal    Decimal   @db.Decimal(12, 2)
  memo        String?   @db.VarChar(500)
  createdAt   DateTime  @default(now()) @map("created_at")

  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_item")
}

// 12. 계약서
model Contract {
  id                 Int       @id @default(autoincrement())
  clientId           Int       @map("client_id")
  storeId            Int?      @map("store_id")
  contractName       String    @map("contract_name") @db.VarChar(255)
  startDate          DateTime  @map("start_date") @db.Date
  endDate            DateTime  @map("end_date") @db.Date
  contractAmount     Decimal   @map("contract_amount") @db.Decimal(12, 2)
  contractSummary    String?   @map("contract_summary")
  contractFile       String?   @map("contract_file") @db.VarChar(500)
  parentContractId   Int?      @map("parent_contract_id")
  isAutoRenewal      String    @default("N") @map("is_auto_renewal") @db.Char(1)
  renewalCount       Int       @default(0) @map("renewal_count")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  client             Client    @relation(fields: [clientId], references: [id])
  store              Store?    @relation(fields: [storeId], references: [id])
  parentContract     Contract? @relation("ContractRenewal", fields: [parentContractId], references: [id])
  renewedContracts   Contract[] @relation("ContractRenewal")

  @@map("contract")
}

// 13. 세금계산서
model Invoice {
  id                Int       @id @default(autoincrement())
  invoiceNumber     String    @unique @map("invoice_number") @db.VarChar(50)
  clientId          Int       @map("client_id")
  orderId           Int?      @map("order_id")
  issueDate         DateTime  @map("issue_date") @db.Date
  subtotal          Decimal   @db.Decimal(12, 2)
  vat               Decimal   @db.Decimal(12, 2)
  total             Decimal   @db.Decimal(12, 2)
  paidAmount        Decimal   @default(0) @map("paid_amount") @db.Decimal(12, 2)
  isPaid            String    @default("N") @map("is_paid") @db.Char(1)
  invoiceType       String    @default("normal") @map("invoice_type") @db.VarChar(20)
  originalInvoiceId Int?      @map("original_invoice_id")
  invoiceFile       String?   @map("invoice_file") @db.VarChar(500)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  client            Client    @relation(fields: [clientId], references: [id])
  order             Order?    @relation(fields: [orderId], references: [id])
  originalInvoice   Invoice?  @relation("InvoiceModification", fields: [originalInvoiceId], references: [id])
  modifiedInvoices  Invoice[] @relation("InvoiceModification")
  payments          Payment[]

  @@map("invoice")
}

// 14. 입금
model Payment {
  id             Int       @id @default(autoincrement())
  clientId       Int       @map("client_id")
  invoiceId      Int       @map("invoice_id")
  paymentDate    DateTime  @map("payment_date") @db.Date
  amount         Decimal   @db.Decimal(12, 2)
  bankAccountId  Int       @map("bank_account_id")
  memo           String?   @db.VarChar(500)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  client         Client      @relation(fields: [clientId], references: [id])
  invoice        Invoice     @relation(fields: [invoiceId], references: [id])
  bankAccount    BankAccount @relation(fields: [bankAccountId], references: [id])

  @@map("payment")
}

// 15. 보고서
model Report {
  id                 Int       @id @default(autoincrement())
  clientId           Int       @map("client_id")
  storeId            Int       @map("store_id")
  reportPeriodStart  DateTime  @map("report_period_start") @db.Date
  reportPeriodEnd    DateTime  @map("report_period_end") @db.Date
  template           String    @db.VarChar(50)
  impressions        Int?
  clicks             Int?
  conversions        Int?
  cost               Decimal?  @db.Decimal(12, 2)
  keywordRanking     String?   @map("keyword_ranking") @db.Text
  reviewCount        Int?      @map("review_count")
  rating             Decimal?  @db.Decimal(3, 2)
  summary            String?
  improvements       String?
  attachments        String?   @db.Text
  sentAt             DateTime? @map("sent_at")
  sentTo             String?   @map("sent_to") @db.VarChar(500)
  sentMethod         String?   @map("sent_method") @db.VarChar(20)
  sentStatus         String?   @map("sent_status") @db.VarChar(20)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  client             Client    @relation(fields: [clientId], references: [id])
  store              Store     @relation(fields: [storeId], references: [id])

  @@map("report")
}

// 16. 번호 관리
model SequenceCounter {
  id           Int      @id @default(autoincrement())
  sequenceType String   @map("sequence_type") @db.VarChar(50)
  prefix       String   @db.VarChar(10)
  year         Int
  month        Int
  lastNumber   Int      @default(0) @map("last_number")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([sequenceType, year, month])
  @@map("sequence_counter")
}

// 17. 감사 로그
model AuditLog {
  id         Int      @id @default(autoincrement())
  tableName  String   @map("table_name") @db.VarChar(50)
  recordId   Int      @map("record_id")
  action     String   @db.VarChar(20)
  fieldName  String?  @map("field_name") @db.VarChar(50)
  oldValue   String?  @map("old_value") @db.Text
  newValue   String?  @map("new_value") @db.Text
  userId     String   @map("user_id") @db.VarChar(50)
  userIp     String?  @map("user_ip") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([tableName, recordId, createdAt])
  @@map("audit_log")
}

// 18. 알림
model Notification {
  id               Int       @id @default(autoincrement())
  notificationType String    @map("notification_type") @db.VarChar(50)
  referenceType    String?   @map("reference_type") @db.VarChar(50)
  referenceId      Int?      @map("reference_id")
  title            String    @db.VarChar(255)
  message          String?   @db.Text
  priority         String    @default("normal") @db.VarChar(20)
  isRead           String    @default("N") @map("is_read") @db.Char(1)
  readAt           DateTime? @map("read_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@index([isRead, createdAt])
  @@map("notification")
}
